<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ ªå–å¼•æˆç¸¾ç®¡ç†</title>
    <meta name="theme-color" content="#3498db">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="æ ªå–å¼•æˆç¸¾ç®¡ç†">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 10px;
            background-color: #f5f5f5;
            font-size: 14px;
        }
        .container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 20px;
            font-size: 20px;
        }
        .section {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }
        .section h2 {
            color: #34495e;
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 16px;
        }
        .input-group {
            margin-bottom: 12px;
        }
        .input-group label {
            display: block;
            font-weight: bold;
            color: #555;
            margin-bottom: 5px;
            font-size: 13px;
        }
        .input-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .input-row input, .input-row select {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .input-row span {
            font-size: 12px;
            color: #666;
            min-width: 20px;
        }
        .result {
            background: #e8f5e8;
            padding: 12px;
            border-radius: 6px;
            margin-top: 15px;
            border-left: 4px solid #27ae60;
        }
        .result h3 {
            margin: 0 0 10px 0;
            color: #27ae60;
            font-size: 14px;
        }
        .result-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            padding: 3px 0;
            border-bottom: 1px solid #d5e8d5;
            font-size: 13px;
        }
        .result-item:last-child {
            border-bottom: none;
        }
        .positive {
            color: #27ae60;
            font-weight: bold;
        }
        .negative {
            color: #e74c3c;
            font-weight: bold;
        }
        .neutral {
            color: #34495e;
        }
        .stats-section {
            background: #e2e3e5;
            border-left-color: #6c757d;
        }
        .history-section {
            background: #fff3cd;
            border-left-color: #ffc107;
        }
        .tabs {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 2px solid #ddd;
        }
        .tab {
            flex: 1;
            padding: 10px;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-size: 12px;
            border-bottom: 2px solid transparent;
        }
        .tab.active {
            background: #3498db;
            color: white;
            border-bottom-color: #3498db;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .profit-loss-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }
        .profit-loss-item {
            background: white;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #ddd;
        }
        .profit-loss-item h4 {
            margin: 0 0 8px 0;
            font-size: 13px;
        }
        .profit-loss-item .amount {
            font-size: 16px;
            font-weight: bold;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }
        .stats-card {
            background: white;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #ddd;
            text-align: center;
        }
        .stats-card h4 {
            margin: 0 0 8px 0;
            font-size: 12px;
            color: #666;
        }
        .stats-card .value {
            font-size: 18px;
            font-weight: bold;
        }
        .add-button {
            background: #3498db;
            color: white;
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
            width: 100%;
            font-size: 14px;
        }
        .add-button:hover {
            background: #2980b9;
        }
        .record-button {
            background: #27ae60;
            color: white;
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
            width: 100%;
            font-size: 14px;
        }
        .record-button:hover {
            background: #229954;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 11px;
        }
        th, td {
            padding: 6px 4px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #3498db;
            color: white;
            font-size: 10px;
        }
        .remove-button {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 3px 6px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 10px;
        }
        .chart-container {
            margin-top: 15px;
            height: 300px;
        }
        .export-section {
            margin-top: 15px;
            padding: 10px;
            background: #d1ecf1;
            border-radius: 6px;
        }
        .export-button {
            background: #17a2b8;
            color: white;
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 12px;
        }
        /* LocalStorageå¯¾å¿œç‰ˆ */
        .save-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #27ae60;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="save-indicator" id="saveIndicator">ğŸ’¾ ä¿å­˜ã—ã¾ã—ãŸ</div>
    
    <div class="container">
        <h1>ğŸ“Š æ ªå–å¼•æˆç¸¾ç®¡ç†</h1>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('simulation')">ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</button>
            <button class="tab" onclick="showTab('portfolio')">ä¿æœ‰æ ª</button>
            <button class="tab" onclick="showTab('history')">å±¥æ­´</button>
            <button class="tab" onclick="showTab('stats')">æˆç¸¾</button>
            <button class="tab" onclick="showTab('chart')">ã‚°ãƒ©ãƒ•</button>
        </div>

        <!-- ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¿ãƒ–ï¼ˆæ—§å–å¼•ã‚¿ãƒ–ï¼‰ -->
        <div id="simulation" class="tab-content active">
            <!-- åŸºæœ¬æƒ…å ±å…¥åŠ› -->
            <div class="section">
                <h2>ğŸ“ éŠ˜æŸ„ãƒ»è³¼å…¥æƒ…å ±</h2>
                <div class="input-group">
                    <label>éŠ˜æŸ„å</label>
                    <div class="input-row">
                        <input type="text" id="stockName" placeholder="ä¾‹: ãƒˆãƒ¨ã‚¿è‡ªå‹•è»Š">
                    </div>
                </div>
                <div class="input-group">
                    <label>è³¼å…¥ä¾¡æ ¼</label>
                    <div class="input-row">
                        <input type="number" id="buyPrice" placeholder="1000">
                        <span>å††</span>
                    </div>
                </div>
                <div class="input-group">
                    <label>è³¼å…¥æ ªæ•°</label>
                    <div class="input-row">
                        <input type="number" id="buyShares" placeholder="100">
                        <span>æ ª</span>
                    </div>
                </div>
                
                <div class="result">
                    <h3>ğŸ’° è³¼å…¥é‡‘é¡</h3>
                    <div class="result-item">
                        <span>è³¼å…¥ä»£é‡‘:</span>
                        <span id="buyAmountOnly" class="neutral">0å††</span>
                    </div>
                    <div class="result-item">
                        <span>æ‰‹æ•°æ–™:</span>
                        <span id="buyFeeOnly" class="neutral">99å††</span>
                    </div>
                    <div class="result-item">
                        <span><strong>åˆè¨ˆæŠ•è³‡é¡:</strong></span>
                        <span id="totalInvestment" class="neutral"><strong>0å††</strong></span>
                    </div>
                </div>
            </div>

            <!-- åˆ©ç¢ºãƒ»æåˆ‡ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ -->
            <div class="section">
                <h2>ğŸ¯ åˆ©ç¢ºãƒ»æåˆ‡ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</h2>
                <div class="input-group">
                    <label>åˆ©ç¢ºä¾¡æ ¼</label>
                    <div class="input-row">
                        <input type="number" id="profitPrice" placeholder="1200">
                        <span>å††</span>
                    </div>
                </div>
                <div class="input-group">
                    <label>æåˆ‡ä¾¡æ ¼</label>
                    <div class="input-row">
                        <input type="number" id="lossPrice" placeholder="900">
                        <span>å††</span>
                    </div>
                </div>
                
                <div class="profit-loss-grid">
                    <div class="profit-loss-item">
                        <h4>ğŸŸ¢ åˆ©ç¢ºæ™‚</h4>
                        <div class="amount positive" id="profitAmount">+0å††</div>
                        <div class="rate positive" id="profitAmountRate">+0%</div>
                    </div>
                    <div class="profit-loss-item">
                        <h4>ğŸ”´ æåˆ‡æ™‚</h4>
                        <div class="amount negative" id="lossAmount">-0å††</div>
                        <div class="rate negative" id="lossAmountRate">-0%</div>
                    </div>
                </div>
            </div>

            <!-- å®Ÿéš›ã®å£²å´ä¾¡æ ¼ã¨çµæœ -->
            <div class="section">
                <h2>ğŸ“ˆ å®Ÿéš›ã®å–å¼•çµæœ</h2>
                <div class="input-group">
                    <label>å®Ÿéš›ã®å£²å´ä¾¡æ ¼</label>
                    <div class="input-row">
                        <input type="number" id="sellPrice" placeholder="å®Ÿéš›ã«å£²å´ã—ãŸä¾¡æ ¼">
                        <span>å††</span>
                    </div>
                </div>
                
                <div class="result">
                    <h3>ğŸ’¹ å–å¼•çµæœ</h3>
                    <div class="result-item">
                        <span>å£²å´é‡‘é¡:</span>
                        <span id="totalSellAmount" class="neutral">0å††</span>
                    </div>
                    <div class="result-item">
                        <span>æ‰‹æ•°æ–™åˆè¨ˆ:</span>
                        <span id="totalFees" class="neutral">198å††</span>
                    </div>
                    <div class="result-item">
                        <span>ç¨é‡‘:</span>
                        <span id="totalTax" class="neutral">0å††</span>
                    </div>
                    <div class="result-item">
                        <span><strong>æœ€çµ‚æç›Š:</strong></span>
                        <span id="finalProfit" class="neutral"><strong>0å††</strong></span>
                    </div>
                    <div class="result-item">
                        <span>æç›Šç‡:</span>
                        <span id="profitRate" class="neutral">0%</span>
                    </div>
                    <div class="result-item">
                        <span>ç›®æ¨™ã¨ã®å·®:</span>
                        <span id="targetDiff" class="neutral">-</span>
                    </div>
                </div>
                
                <button class="add-button" onclick="addToPortfolio()">ğŸ“ˆ ä¿æœ‰æ ªã«è¿½åŠ </button>
                <button class="record-button" onclick="recordTrade()">ğŸ“ å–å¼•ã‚’è¨˜éŒ²ã—ã¦åçœææ–™ã«</button>
            </div>
        </div>

        <!-- ä¿æœ‰æ ªã‚¿ãƒ– -->
        <div id="portfolio" class="tab-content">
            <div class="section summary">
                <h2>ğŸ“Š ä¿æœ‰æ ªä¸€è¦§</h2>
                <table id="portfolioTable">
                    <thead>
                        <tr>
                            <th>éŠ˜æŸ„</th>
                            <th>è³¼å…¥ä¾¡æ ¼</th>
                            <th>æ ªæ•°</th>
                            <th>ç¾åœ¨ä¾¡æ ¼</th>
                            <th>åˆ©ç¢ºç›®æ¨™</th>
                            <th>æåˆ‡ä¾¡æ ¼</th>
                            <th>è©•ä¾¡é¡</th>
                            <th>æç›Š</th>
                            <th>æç›Šç‡</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="portfolioBody">
                        <!-- å‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹è¡Œ -->
                    </tbody>
                </table>
                
                <div class="result">
                    <h3>ğŸ“Š ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªå…¨ä½“</h3>
                    <div class="result-item">
                        <span>ç·æŠ•è³‡é¡:</span>
                        <span id="totalPortfolioInvestment" class="neutral">0å††</span>
                    </div>
                    <div class="result-item">
                        <span>ç·è©•ä¾¡é¡:</span>
                        <span id="totalPortfolioValue" class="neutral">0å††</span>
                    </div>
                    <div class="result-item">
                        <span><strong>ç·æç›Š:</strong></span>
                        <span id="totalPortfolioProfit" class="neutral"><strong>0å††</strong></span>
                    </div>
                    <div class="result-item">
                        <span>ç·æç›Šç‡:</span>
                        <span id="totalPortfolioProfitRate" class="neutral">0%</span>
                    </div>
                </div>

                <!-- å€‹åˆ¥éŠ˜æŸ„è©³ç´°ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ -->
                <div class="section" id="selectedStockDetail" style="display: none;">
                    <h2 id="selectedStockName">ğŸ“ˆ éŠ˜æŸ„è©³ç´°</h2>
                    <div class="profit-loss-grid">
                        <div class="profit-loss-item">
                            <h4>ğŸŸ¢ åˆ©ç¢ºæ™‚äºˆæƒ³</h4>
                            <div class="amount positive" id="selectedProfitAmount">+0å††</div>
                            <div class="rate positive" id="selectedProfitRate">+0%</div>
                        </div>
                        <div class="profit-loss-item">
                            <h4>ğŸ”´ æåˆ‡æ™‚äºˆæƒ³</h4>
                            <div class="amount negative" id="selectedLossAmount">-0å††</div>
                            <div class="rate negative" id="selectedLossRate">-0%</div>
                        </div>
                    </div>
                    <div class="profit-loss-grid">
                        <div class="profit-loss-item">
                            <h4>ğŸ“Š ç¾åœ¨çŠ¶æ³</h4>
                            <div class="amount neutral" id="selectedCurrentAmount">0å††</div>
                            <div class="rate neutral" id="selectedCurrentRate">0%</div>
                        </div>
                        <div class="profit-loss-item">
                            <h4>ğŸ¯ ç›®æ¨™ã¾ã§</h4>
                            <div class="amount neutral" id="selectedTargetProgress">-</div>
                            <div class="rate neutral" id="selectedTargetPercent">-</div>
                        </div>
                    </div>
                    
                    <div class="input-group" style="margin-top: 15px;">
                        <label>å£²å´ä¾¡æ ¼å…¥åŠ›ï¼ˆå–å¼•è¨˜éŒ²ç”¨ï¼‰</label>
                        <div class="input-row">
                            <input type="number" id="portfolioSellPrice" placeholder="å®Ÿéš›ã®å£²å´ä¾¡æ ¼">
                            <span>å††</span>
                            <button class="record-button" onclick="sellFromPortfolio()" style="margin: 0; width: auto; padding: 6px 12px;">å£²å´è¨˜éŒ²</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- å–å¼•å±¥æ­´ã‚¿ãƒ– -->
        <div id="history" class="tab-content">
            <div class="section history-section">
                <h2>ğŸ“‹ å–å¼•å±¥æ­´</h2>
                <table id="historyTable">
                    <thead>
                        <tr>
                            <th>æ—¥ä»˜</th>
                            <th>éŠ˜æŸ„</th>
                            <th>æ ªæ•°</th>
                            <th>è³¼å…¥ä¾¡æ ¼</th>
                            <th>å£²å´ä¾¡æ ¼</th>
                            <th>æç›Š</th>
                            <th>æç›Šç‡</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="historyBody">
                        <!-- å‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹è¡Œ -->
                    </tbody>
                </table>
                
                <div class="export-section">
                    <h4>ğŸ“¤ ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h4>
                    <button class="export-button" onclick="exportData()">CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                    <button class="export-button" onclick="backupData()">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</button>
                    <button class="export-button" onclick="showImportModal()">ãƒ‡ãƒ¼ã‚¿å¾©å…ƒ</button>
                    <button class="export-button" onclick="syncData()">ãƒ‡ãƒã‚¤ã‚¹é–“åŒæœŸ</button>
                    <button class="export-button" onclick="clearHistory()">å±¥æ­´ã‚¯ãƒªã‚¢</button>
                </div>

                <!-- ãƒ‡ãƒ¼ã‚¿åŒæœŸãƒ¢ãƒ¼ãƒ€ãƒ« -->
                <div id="syncModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 8px; max-width: 90%; width: 400px;">
                        <h3>ğŸ”„ ãƒ‡ãƒã‚¤ã‚¹é–“åŒæœŸ</h3>
                        <p>ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ã€ä»–ã®ãƒ‡ãƒã‚¤ã‚¹ã§ã€Œãƒ‡ãƒ¼ã‚¿å¾©å…ƒã€ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ï¼š</p>
                        <textarea id="syncCode" readonly style="width: 100%; height: 100px; margin: 10px 0; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;"></textarea>
                        <div style="text-align: center; margin-top: 15px;">
                            <button onclick="copySyncCode()" style="background: #27ae60; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin: 5px;">ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼</button>
                            <button onclick="closeSyncModal()" style="background: #95a5a6; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin: 5px;">é–‰ã˜ã‚‹</button>
                        </div>
                    </div>
                </div>

                <!-- ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
                <div id="importModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 8px; max-width: 90%; width: 400px;">
                        <h3>ğŸ“¥ ãƒ‡ãƒ¼ã‚¿å¾©å…ƒ</h3>
                        <p>ä»–ã®ãƒ‡ãƒã‚¤ã‚¹ã§ç”Ÿæˆã—ãŸåŒæœŸã‚³ãƒ¼ãƒ‰ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ï¼š</p>
                        <textarea id="importCode" placeholder="åŒæœŸã‚³ãƒ¼ãƒ‰ã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘..." style="width: 100%; height: 100px; margin: 10px 0; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;"></textarea>
                        <div style="text-align: center; margin-top: 15px;">
                            <button onclick="importData()" style="background: #3498db; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin: 5px;">ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒ</button>
                            <button onclick="closeImportModal()" style="background: #95a5a6; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin: 5px;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æˆç¸¾çµ±è¨ˆã‚¿ãƒ– -->
        <div id="stats" class="tab-content">
            <div class="section stats-section">
                <h2>ğŸ“Š å–å¼•æˆç¸¾çµ±è¨ˆ</h2>
                
                <div class="stats-grid">
                    <div class="stats-card">
                        <h4>ç·å–å¼•å›æ•°</h4>
                        <div class="value neutral" id="totalTrades">0å›</div>
                    </div>
                    <div class="stats-card">
                        <h4>å‹ç‡</h4>
                        <div class="value positive" id="winRate">0%</div>
                    </div>
                    <div class="stats-card">
                        <h4>å‹ã¡å›æ•°</h4>
                        <div class="value positive" id="winCount">0å›</div>
                    </div>
                    <div class="stats-card">
                        <h4>è² ã‘å›æ•°</h4>
                        <div class="value negative" id="loseCount">0å›</div>
                    </div>
                    <div class="stats-card">
                        <h4>ç·åˆ©ç›Š</h4>
                        <div class="value positive" id="totalProfit">0å††</div>
                    </div>
                    <div class="stats-card">
                        <h4>å¹³å‡åˆ©ç›Šç‡</h4>
                        <div class="value neutral" id="avgProfitRate">0%</div>
                    </div>
                </div>

                <div class="result">
                    <h3>ğŸ“ˆ æœˆåˆ¥æˆç¸¾</h3>
                    <div class="result-item">
                        <span>ä»Šæœˆã®å–å¼•:</span>
                        <span id="monthlyTrades" class="neutral">0å›</span>
                    </div>
                    <div class="result-item">
                        <span>ä»Šæœˆã®æç›Š:</span>
                        <span id="monthlyProfit" class="neutral">0å††</span>
                    </div>
                    <div class="result-item">
                        <span>ä»Šæœˆã®å‹ç‡:</span>
                        <span id="monthlyWinRate" class="neutral">0%</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ã‚°ãƒ©ãƒ•ã‚¿ãƒ– -->
        <div id="chart" class="tab-content">
            <div class="section">
                <h2>ğŸ“ˆ æç›Šæ¨ç§»ã‚°ãƒ©ãƒ•</h2>
                <div class="chart-container">
                    <canvas id="profitChart"></canvas>
                </div>
            </div>
            
            <div class="section">
                <h2>ğŸ¥§ å‹æ•—æ¯”ç‡</h2>
                <div class="chart-container">
                    <canvas id="winLossChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ãƒ‡ãƒ¼ã‚¿ç®¡ç†ï¼ˆLocalStorageä½¿ç”¨ï¼‰
        let tradeHistory = [];
        let portfolioData = [];
        let charts = {};
        let selectedStockId = null;

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            if (tabName === 'chart') {
                setTimeout(updateCharts, 100);
            }
            if (tabName === 'stats') {
                updateStats();
            }
            if (tabName === 'portfolio') {
                updatePortfolioTable();
                updatePortfolioSummary();
            }
        }

        // ä¿å­˜ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼è¡¨ç¤º
        function showSaveIndicator() {
            const indicator = document.getElementById('saveIndicator');
            indicator.style.display = 'block';
            setTimeout(() => {
                indicator.style.display = 'none';
            }, 2000);
        }

        // ãƒ‡ãƒ¼ã‚¿ä¿å­˜ãƒ»èª­ã¿è¾¼ã¿ï¼ˆLocalStorageä½¿ç”¨ï¼‰
        function saveData() {
            try {
                const data = {
                    history: tradeHistory,
                    portfolio: portfolioData,
                    lastSaved: new Date().toISOString()
                };
                localStorage.setItem('stockTradingData', JSON.stringify(data));
                showSaveIndicator();
            } catch (e) {
                console.warn('ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ:', e);
            }
        }

        function loadData() {
            try {
                const saved = localStorage.getItem('stockTradingData');
                if (saved) {
                    const data = JSON.parse(saved);
                    tradeHistory = data.history || [];
                    portfolioData = data.portfolio || [];
                    updateHistoryTable();
                    updatePortfolioTable();
                    updatePortfolioSummary();
                    updateStats();
                }
            } catch (e) {
                console.warn('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:', e);
                tradeHistory = [];
                portfolioData = [];
            }
        }

        // å–å¼•è¨ˆç®—ï¼ˆæ–°ã—ã„ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå¯¾å¿œï¼‰
        function calculateTrade() {
            const buyPrice = parseFloat(document.getElementById('buyPrice').value) || 0;
            const buyShares = parseInt(document.getElementById('buyShares').value) || 0;
            const sellPrice = parseFloat(document.getElementById('sellPrice').value) || 0;
            const profitPrice = parseFloat(document.getElementById('profitPrice').value) || 0;
            const lossPrice = parseFloat(document.getElementById('lossPrice').value) || 0;
            const buyFee = 99;

            // è³¼å…¥æƒ…å ±ã®è¨ˆç®—
            const buyAmount = buyPrice * buyShares;
            const totalInvestmentAmount = buyAmount + buyFee;

            document.getElementById('buyAmountOnly').textContent = buyAmount.toLocaleString() + 'å††';
            document.getElementById('buyFeeOnly').textContent = buyFee.toLocaleString() + 'å††';
            document.getElementById('totalInvestment').textContent = totalInvestmentAmount.toLocaleString() + 'å††';

            // å®Ÿéš›ã®å–å¼•çµæœ
            if (sellPrice > 0 && buyShares > 0) {
                const sellAmount = sellPrice * buyShares;
                const totalFees = buyFee * 2;
                const grossProfit = sellAmount - buyAmount - totalFees;
                const tax = grossProfit > 0 ? grossProfit * 0.20315 : 0;
                const finalProfit = grossProfit - tax;
                const profitRate = buyAmount > 0 ? (finalProfit / buyAmount) * 100 : 0;

                document.getElementById('totalSellAmount').textContent = sellAmount.toLocaleString() + 'å††';
                document.getElementById('totalFees').textContent = totalFees.toLocaleString() + 'å††';
                document.getElementById('totalTax').textContent = tax.toLocaleString() + 'å††';
                document.getElementById('finalProfit').textContent = finalProfit.toLocaleString() + 'å††';
                document.getElementById('profitRate').textContent = profitRate.toFixed(2) + '%';

                // ç›®æ¨™ã¨ã®å·®ã‚’è¨ˆç®—
                let targetDiffText = '-';
                if (profitPrice > 0 && finalProfit > 0) {
                    // åˆ©ç¢ºç›®æ¨™ã¨æ¯”è¼ƒ
                    const profitTarget = calculateProfitLossAmount(profitPrice, buyPrice, buyShares, buyFee);
                    const diff = finalProfit - profitTarget;
                    targetDiffText = `åˆ©ç¢ºç›®æ¨™ã‚ˆã‚Š${diff >= 0 ? '+' : ''}${diff.toLocaleString()}å††`;
                } else if (lossPrice > 0 && finalProfit < 0) {
                    // æåˆ‡ç›®æ¨™ã¨æ¯”è¼ƒ
                    const lossTarget = calculateProfitLossAmount(lossPrice, buyPrice, buyShares, buyFee);
                    const diff = finalProfit - lossTarget;
                    targetDiffText = `æåˆ‡ç›®æ¨™ã‚ˆã‚Š${diff >= 0 ? '+' : ''}${diff.toLocaleString()}å††`;
                }
                document.getElementById('targetDiff').textContent = targetDiffText;

                // è‰²åˆ†ã‘
                const profitElement = document.getElementById('finalProfit');
                const rateElement = document.getElementById('profitRate');
                const targetElement = document.getElementById('targetDiff');
                
                if (finalProfit > 0) {
                    profitElement.className = 'positive';
                    rateElement.className = 'positive';
                } else if (finalProfit < 0) {
                    profitElement.className = 'negative';
                    rateElement.className = 'negative';
                } else {
                    profitElement.className = 'neutral';
                    rateElement.className = 'neutral';
                }

                if (targetDiffText.includes('+')) {
                    targetElement.className = 'positive';
                } else if (targetDiffText.includes('-') && targetDiffText !== '-') {
                    targetElement.className = 'negative';
                } else {
                    targetElement.className = 'neutral';
                }
            } else {
                // å£²å´ä¾¡æ ¼ãŒæœªå…¥åŠ›ã®å ´åˆ
                document.getElementById('totalSellAmount').textContent = '0å††';
                document.getElementById('totalFees').textContent = '198å††';
                document.getElementById('totalTax').textContent = '0å††';
                document.getElementById('finalProfit').textContent = '0å††';
                document.getElementById('profitRate').textContent = '0%';
                document.getElementById('targetDiff').textContent = '-';
            }

            calculateProfitLoss();
        }

        // åˆ©ç¢ºãƒ»æåˆ‡è¨ˆç®—ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        function calculateProfitLossAmount(targetPrice, buyPrice, buyShares, buyFee) {
            const buyAmount = buyPrice * buyShares;
            const sellAmount = targetPrice * buyShares;
            const totalFees = buyFee * 2;
            const grossProfit = sellAmount - buyAmount - totalFees;
            const tax = grossProfit > 0 ? grossProfit * 0.20315 : 0;
            return grossProfit - tax;
        }

        function calculateProfitLoss() {
            const buyPrice = parseFloat(document.getElementById('buyPrice').value) || 0;
            const buyShares = parseInt(document.getElementById('buyShares').value) || 0;
            const profitPrice = parseFloat(document.getElementById('profitPrice').value) || 0;
            const lossPrice = parseFloat(document.getElementById('lossPrice').value) || 0;
            const buyFee = 99;

            // åˆ©ç¢ºè¨ˆç®—
            if (profitPrice > 0 && buyShares > 0) {
                const profitFinal = calculateProfitLossAmount(profitPrice, buyPrice, buyShares, buyFee);
                const buyAmount = buyPrice * buyShares;
                const profitRate = buyAmount > 0 ? (profitFinal / buyAmount) * 100 : 0;

                document.getElementById('profitAmount').textContent = '+' + profitFinal.toLocaleString() + 'å††';
                document.getElementById('profitAmountRate').textContent = '+' + profitRate.toFixed(2) + '%';
            } else {
                document.getElementById('profitAmount').textContent = '+0å††';
                document.getElementById('profitAmountRate').textContent = '+0%';
            }

            // æåˆ‡è¨ˆç®—
            if (lossPrice > 0 && buyShares > 0) {
                const lossFinal = calculateProfitLossAmount(lossPrice, buyPrice, buyShares, buyFee);
                const buyAmount = buyPrice * buyShares;
                const lossRate = buyAmount > 0 ? (lossFinal / buyAmount) * 100 : 0;

                document.getElementById('lossAmount').textContent = lossFinal.toLocaleString() + 'å††';
                document.getElementById('lossAmountRate').textContent = lossRate.toFixed(2) + '%';
            } else {
                document.getElementById('lossAmount').textContent = '-0å††';
                document.getElementById('lossAmountRate').textContent = '-0%';
            }
        }

        // ä¿æœ‰æ ªã«è¿½åŠ 
        function addToPortfolio() {
            const stockName = document.getElementById('stockName').value || 'æœªå…¥åŠ›';
            const buyPrice = parseFloat(document.getElementById('buyPrice').value) || 0;
            const buyShares = parseInt(document.getElementById('buyShares').value) || 0;
            const profitPrice = parseFloat(document.getElementById('profitPrice').value) || 0;
            const lossPrice = parseFloat(document.getElementById('lossPrice').value) || 0;

            if (buyPrice > 0 && buyShares > 0) {
                const stock = {
                    id: Date.now(),
                    name: stockName,
                    buyPrice: buyPrice,
                    shares: buyShares,
                    currentPrice: buyPrice, // åˆæœŸå€¤ã¯è³¼å…¥ä¾¡æ ¼
                    profitTarget: profitPrice,
                    lossTarget: lossPrice,
                    addedDate: new Date().toLocaleDateString('ja-JP')
                };

                portfolioData.push(stock);
                saveData();
                updatePortfolioTable();
                updatePortfolioSummary();

                // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚¯ãƒªã‚¢
                document.getElementById('stockName').value = '';
                document.getElementById('buyPrice').value = '';
                document.getElementById('buyShares').value = '';
                document.getElementById('profitPrice').value = '';
                document.getElementById('lossPrice').value = '';
                calculateTrade();

                alert('ä¿æœ‰æ ªã«è¿½åŠ ã—ã¾ã—ãŸï¼');
            } else {
                alert('éŠ˜æŸ„åã€è³¼å…¥ä¾¡æ ¼ã€è³¼å…¥æ ªæ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
            }
        }

        // ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°
        function updatePortfolioTable() {
            const tbody = document.getElementById('portfolioBody');
            tbody.innerHTML = '';

            portfolioData.forEach(stock => {
                const investmentAmount = stock.buyPrice * stock.shares + 99; // æ‰‹æ•°æ–™è¾¼ã¿
                const currentValue = stock.currentPrice * stock.shares;
                const profit = currentValue - investmentAmount;
                const profitRate = (profit / investmentAmount) * 100;

                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${stock.name}</td>
                    <td>Â¥${stock.buyPrice.toLocaleString()}</td>
                    <td>${stock.shares}</td>
                    <td><input type="number" value="${stock.currentPrice}" onchange="updateCurrentPrice(${stock.id}, this.value)" style="width: 70px; padding: 4px; font-size: 12px;"></td>
                    <td>Â¥${stock.profitTarget.toLocaleString()}</td>
                    <td>Â¥${stock.lossTarget.toLocaleString()}</td>
                    <td>Â¥${currentValue.toLocaleString()}</td>
                    <td class="${profit >= 0 ? 'positive' : 'negative'}">Â¥${profit.toLocaleString()}</td>
                    <td class="${profitRate >= 0 ? 'positive' : 'negative'}">${profitRate.toFixed(2)}%</td>
                    <td>
                        <button onclick="selectStock(${stock.id})" style="background: #3498db; color: white; border: none; padding: 3px 6px; border-radius: 3px; cursor: pointer; font-size: 10px; margin: 1px;">è©³ç´°</button>
                        <button onclick="removeFromPortfolio(${stock.id})" class="remove-button">å‰Šé™¤</button>
                    </td>
                `;
            });
        }

        // ç¾åœ¨ä¾¡æ ¼æ›´æ–°
        function updateCurrentPrice(id, newPrice) {
            const stock = portfolioData.find(s => s.id === id);
            if (stock) {
                stock.currentPrice = parseFloat(newPrice) || 0;
                saveData();
                updatePortfolioTable();
                updatePortfolioSummary();
                if (selectedStockId === id) {
                    updateSelectedStockDetail();
                }
            }
        }

        // ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã‚µãƒãƒªãƒ¼æ›´æ–°
        function updatePortfolioSummary() {
            const totalInvestment = portfolioData.reduce((sum, stock) => sum + (stock.buyPrice * stock.shares + 99), 0);
            const totalValue = portfolioData.reduce((sum, stock) => sum + (stock.currentPrice * stock.shares), 0);
            const totalProfit = totalValue - totalInvestment;
            const totalProfitRate = totalInvestment > 0 ? (totalProfit / totalInvestment) * 100 : 0;

            document.getElementById('totalPortfolioInvestment').textContent = totalInvestment.toLocaleString() + 'å††';
            document.getElementById('totalPortfolioValue').textContent = totalValue.toLocaleString() + 'å††';
            document.getElementById('totalPortfolioProfit').textContent = totalProfit.toLocaleString() + 'å††';
            document.getElementById('totalPortfolioProfitRate').textContent = totalProfitRate.toFixed(2) + '%';

            // è‰²åˆ†ã‘
            const profitElement = document.getElementById('totalPortfolioProfit');
            const rateElement = document.getElementById('totalPortfolioProfitRate');
            
            if (totalProfit > 0) {
                profitElement.className = 'positive';
                rateElement.className = 'positive';
            } else if (totalProfit < 0) {
                profitElement.className = 'negative';
                rateElement.className = 'negative';
            } else {
                profitElement.className = 'neutral';
                rateElement.className = 'neutral';
            }
        }

        // éŠ˜æŸ„é¸æŠ
        function selectStock(id) {
            selectedStockId = id;
            updateSelectedStockDetail();
            document.getElementById('selectedStockDetail').style.display = 'block';
        }

        // é¸æŠã•ã‚ŒãŸéŠ˜æŸ„ã®è©³ç´°æ›´æ–°
        function updateSelectedStockDetail() {
            const stock = portfolioData.find(s => s.id === selectedStockId);
            if (!stock) return;

            document.getElementById('selectedStockName').textContent = `ğŸ“ˆ ${stock.name} è©³ç´°ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³`;

            const investmentAmount = stock.buyPrice * stock.shares + 99;
            const currentValue = stock.currentPrice * stock.shares;
            const currentProfit = currentValue - investmentAmount;
            const currentProfitRate = (currentProfit / investmentAmount) * 100;

            // åˆ©ç¢ºæ™‚è¨ˆç®—
            const profitValue = stock.profitTarget * stock.shares;
            const profitAmount = profitValue - investmentAmount - 99;
            const profitTax = profitAmount > 0 ? profitAmount * 0.20315 : 0;
            const finalProfitAmount = profitAmount - profitTax;
            const finalProfitRate = (finalProfitAmount / investmentAmount) * 100;

            // æåˆ‡æ™‚è¨ˆç®—
            const lossValue = stock.lossTarget * stock.shares;
            const lossAmount = lossValue - investmentAmount - 99;
            const lossTax = lossAmount > 0 ? lossAmount * 0.20315 : 0;
            const finalLossAmount = lossAmount - lossTax;
            const finalLossRate = (finalLossAmount / investmentAmount) * 100;

            // ç›®æ¨™ã¾ã§ã®é€²æ—
            let targetProgress = '-';
            let targetPercent = '-';
            if (currentProfit > 0 && stock.profitTarget > 0) {
                const progressToProfit = (stock.currentPrice - stock.buyPrice) / (stock.profitTarget - stock.buyPrice) * 100;
                targetProgress = `åˆ©ç¢ºã¾ã§${(100 - progressToProfit).toFixed(1)}%`;
                targetPercent = `ã‚ã¨Â¥${((stock.profitTarget - stock.currentPrice) * stock.shares).toLocaleString()}`;
            } else if (currentProfit < 0 && stock.lossTarget > 0) {
                const progressToLoss = Math.abs((stock.currentPrice - stock.buyPrice) / (stock.lossTarget - stock.buyPrice)) * 100;
                targetProgress = `æåˆ‡ã¾ã§${(100 - progressToLoss).toFixed(1)}%`;
                targetPercent = `ã‚ã¨Â¥${Math.abs((stock.lossTarget - stock.currentPrice) * stock.shares).toLocaleString()}`;
            }

            document.getElementById('selectedProfitAmount').textContent = '+' + finalProfitAmount.toLocaleString() + 'å††';
            document.getElementById('selectedProfitRate').textContent = '+' + finalProfitRate.toFixed(2) + '%';
            document.getElementById('selectedLossAmount').textContent = finalLossAmount.toLocaleString() + 'å††';
            document.getElementById('selectedLossRate').textContent = finalLossRate.toFixed(2) + '%';
            document.getElementById('selectedCurrentAmount').textContent = currentProfit.toLocaleString() + 'å††';
            document.getElementById('selectedCurrentRate').textContent = currentProfitRate.toFixed(2) + '%';
            document.getElementById('selectedTargetProgress').textContent = targetProgress;
            document.getElementById('selectedTargetPercent').textContent = targetPercent;

            // è‰²åˆ†ã‘
            document.getElementById('selectedCurrentAmount').className = currentProfit >= 0 ? 'positive' : 'negative';
            document.getElementById('selectedCurrentRate').className = currentProfitRate >= 0 ? 'positive' : 'negative';
        }

        // ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã‹ã‚‰å£²å´
        function sellFromPortfolio() {
            if (!selectedStockId) {
                alert('éŠ˜æŸ„ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            const sellPrice = parseFloat(document.getElementById('portfolioSellPrice').value);
            if (!sellPrice || sellPrice <= 0) {
                alert('å£²å´ä¾¡æ ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            const stock = portfolioData.find(s => s.id === selectedStockId);
            if (!stock) return;

            // å–å¼•å±¥æ­´ã«è¿½åŠ 
            const investmentAmount = stock.buyPrice * stock.shares + 99;
            const sellAmount = sellPrice * stock.shares;
            const totalFees = 99 * 2;
            const grossProfit = sellAmount - (stock.buyPrice * stock.shares) - totalFees;
            const tax = grossProfit > 0 ? grossProfit * 0.20315 : 0;
            const finalProfit = grossProfit - tax;
            const profitRate = (finalProfit / (stock.buyPrice * stock.shares)) * 100;

            const trade = {
                id: Date.now(),
                date: new Date().toLocaleDateString('ja-JP'),
                stockName: stock.name,
                buyPrice: stock.buyPrice,
                sellPrice: sellPrice,
                shares: stock.shares,
                profit: finalProfit,
                profitRate: profitRate,
                isWin: finalProfit > 0,
                profitTarget: stock.profitTarget,
                lossTarget: stock.lossTarget
            };

            tradeHistory.push(trade);

            // ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã‹ã‚‰å‰Šé™¤
            portfolioData = portfolioData.filter(s => s.id !== selectedStockId);
            selectedStockId = null;
            document.getElementById('selectedStockDetail').style.display = 'none';
            document.getElementById('portfolioSellPrice').value = '';

            saveData();
            updatePortfolioTable();
            updatePortfolioSummary();
            updateHistoryTable();
            updateStats();

            alert(`${stock.name}ã‚’å£²å´è¨˜éŒ²ã—ã¾ã—ãŸï¼`);
        }

        // ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã‹ã‚‰å‰Šé™¤
        function removeFromPortfolio(id) {
            if (confirm('ã“ã®éŠ˜æŸ„ã‚’ä¿æœ‰æ ªã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                portfolioData = portfolioData.filter(stock => stock.id !== id);
                if (selectedStockId === id) {
                    selectedStockId = null;
                    document.getElementById('selectedStockDetail').style.display = 'none';
                }
                saveData();
                updatePortfolioTable();
                updatePortfolioSummary();
            }
        }
        function recordTrade() {
            const stockName = document.getElementById('stockName').value || 'æœªå…¥åŠ›';
            const buyPrice = parseFloat(document.getElementById('buyPrice').value) || 0;
            const buyShares = parseInt(document.getElementById('buyShares').value) || 0;
            const sellPrice = parseFloat(document.getElementById('sellPrice').value) || 0;

            if (buyPrice > 0 && buyShares > 0 && sellPrice > 0) {
                const buyAmount = buyPrice * buyShares;
                const sellAmount = sellPrice * buyShares;
                const totalFees = 99 * 2;
                const grossProfit = sellAmount - buyAmount - totalFees;
                const tax = grossProfit > 0 ? grossProfit * 0.20315 : 0;
                const finalProfit = grossProfit - tax;
                const profitRate = (finalProfit / buyAmount) * 100;

                const trade = {
                    id: Date.now(),
                    date: new Date().toLocaleDateString('ja-JP'),
                    stockName: stockName,
                    buyPrice: buyPrice,
                    sellPrice: sellPrice,
                    shares: buyShares,
                    profit: finalProfit,
                    profitRate: profitRate,
                    isWin: finalProfit > 0
                };

                tradeHistory.push(trade);
                saveData();
                updateHistoryTable();
                updateStats();

                // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚¯ãƒªã‚¢
                document.getElementById('stockName').value = '';
                document.getElementById('buyPrice').value = '';
                document.getElementById('buyShares').value = '';
                document.getElementById('sellPrice').value = '';
                calculateTrade();

                alert('å–å¼•ã‚’è¨˜éŒ²ã—ã¾ã—ãŸï¼');
            } else {
                alert('ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
            }
        }

        // å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°
        function updateHistoryTable() {
            const tbody = document.getElementById('historyBody');
            tbody.innerHTML = '';

            tradeHistory.slice().reverse().forEach(trade => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${trade.date}</td>
                    <td>${trade.stockName}</td>
                    <td>${trade.shares}</td>
                    <td>Â¥${trade.buyPrice.toLocaleString()}</td>
                    <td>Â¥${trade.sellPrice.toLocaleString()}</td>
                    <td class="${trade.profit >= 0 ? 'positive' : 'negative'}">Â¥${trade.profit.toLocaleString()}</td>
                    <td class="${trade.profitRate >= 0 ? 'positive' : 'negative'}">${trade.profitRate.toFixed(2)}%</td>
                    <td><button onclick="removeTrade(${trade.id})" class="remove-button">å‰Šé™¤</button></td>
                `;
            });
        }

        // çµ±è¨ˆæ›´æ–°
        function updateStats() {
            const totalTrades = tradeHistory.length;
            const wins = tradeHistory.filter(t => t.isWin).length;
            const losses = totalTrades - wins;
            const winRate = totalTrades > 0 ? (wins / totalTrades) * 100 : 0;
            const totalProfit = tradeHistory.reduce((sum, t) => sum + t.profit, 0);
            const avgProfitRate = totalTrades > 0 ? tradeHistory.reduce((sum, t) => sum + t.profitRate, 0) / totalTrades : 0;

            // ä»Šæœˆã®ãƒ‡ãƒ¼ã‚¿
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const monthlyTrades = tradeHistory.filter(t => {
                const tradeDate = new Date(t.date);
                return tradeDate.getMonth() === currentMonth && tradeDate.getFullYear() === currentYear;
            });
            const monthlyWins = monthlyTrades.filter(t => t.isWin).length;
            const monthlyWinRate = monthlyTrades.length > 0 ? (monthlyWins / monthlyTrades.length) * 100 : 0;
            const monthlyProfit = monthlyTrades.reduce((sum, t) => sum + t.profit, 0);

            document.getElementById('totalTrades').textContent = totalTrades + 'å›';
            document.getElementById('winRate').textContent = winRate.toFixed(1) + '%';
            document.getElementById('winCount').textContent = wins + 'å›';
            document.getElementById('loseCount').textContent = losses + 'å›';
            document.getElementById('totalProfit').textContent = totalProfit.toLocaleString() + 'å††';
            document.getElementById('avgProfitRate').textContent = avgProfitRate.toFixed(2) + '%';
            
            document.getElementById('monthlyTrades').textContent = monthlyTrades.length + 'å›';
            document.getElementById('monthlyProfit').textContent = monthlyProfit.toLocaleString() + 'å††';
            document.getElementById('monthlyWinRate').textContent = monthlyWinRate.toFixed(1) + '%';

            // è‰²åˆ†ã‘
            document.getElementById('totalProfit').className = totalProfit >= 0 ? 'positive' : 'negative';
            document.getElementById('monthlyProfit').className = monthlyProfit >= 0 ? 'positive' : 'negative';
        }

        // ã‚°ãƒ©ãƒ•æ›´æ–°
        function updateCharts() {
            updateProfitChart();
            updateWinLossChart();
        }

        function updateProfitChart() {
            const ctx = document.getElementById('profitChart').getContext('2d');
            
            if (charts.profit) {
                charts.profit.destroy();
            }

            // ç´¯ç©æç›Šã®ãƒ‡ãƒ¼ã‚¿ä½œæˆ
            let cumulativeProfit = 0;
            const data = tradeHistory.map((trade, index) => {
                cumulativeProfit += trade.profit;
                return {
                    x: index + 1,
                    y: cumulativeProfit
                };
            });

            charts.profit = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'ç´¯ç©æç›Š (å††)',
                        data: data,
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        tension: 0.2,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'å–å¼•å›æ•°'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'ç´¯ç©æç›Š (å††)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        function updateWinLossChart() {
            const ctx = document.getElementById('winLossChart').getContext('2d');
            
            if (charts.winLoss) {
                charts.winLoss.destroy();
            }

            const wins = tradeHistory.filter(t => t.isWin).length;
            const losses = tradeHistory.length - wins;

            if (wins === 0 && losses === 0) {
                // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ã‚°ãƒ©ãƒ•ã‚’è¡¨ç¤ºã—ãªã„
                return;
            }

            charts.winLoss = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['å‹ã¡', 'è² ã‘'],
                    datasets: [{
                        data: [wins, losses],
                        backgroundColor: ['#27ae60', '#e74c3c'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // å–å¼•å‰Šé™¤
        function removeTrade(id) {
            if (confirm('ã“ã®å–å¼•ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                tradeHistory = tradeHistory.filter(trade => trade.id !== id);
                saveData();
                updateHistoryTable();
                updateStats();
            }
        }

        // ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        function exportData() {
            if (tradeHistory.length === 0) {
                alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }

            const csvContent = "data:text/csv;charset=utf-8," 
                + "æ—¥ä»˜,éŠ˜æŸ„å,è³¼å…¥ä¾¡æ ¼,å£²å´ä¾¡æ ¼,æ ªæ•°,æç›Š,æç›Šç‡\n"
                + tradeHistory.map(trade => 
                    `${trade.date},${trade.stockName},${trade.buyPrice},${trade.sellPrice},${trade.shares},${trade.profit},${trade.profitRate}%`
                ).join("\n");

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `æ ªå–å¼•å±¥æ­´_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
        function backupData() {
            if (tradeHistory.length === 0) {
                alert('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }

            const backupData = {
                version: '1.0',
                exportDate: new Date().toISOString(),
                tradeHistory: tradeHistory
            };

            const dataStr = JSON.stringify(backupData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement("a");
            link.href = URL.createObjectURL(dataBlob);
            link.download = `æ ªå–å¼•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚');
        }

        // ãƒ‡ãƒ¼ã‚¿åŒæœŸæ©Ÿèƒ½
        function syncData() {
            const syncData = {
                version: '1.0',
                timestamp: new Date().toISOString(),
                tradeHistory: tradeHistory,
                portfolioData: portfolioData
            };

            const syncCode = btoa(JSON.stringify(syncData));
            document.getElementById('syncCode').value = syncCode;
            document.getElementById('syncModal').style.display = 'block';
        }

        function showImportModal() {
            document.getElementById('importModal').style.display = 'block';
        }

        function importData() {
            const importCode = document.getElementById('importCode').value.trim();
            if (!importCode) {
                alert('åŒæœŸã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            try {
                const syncData = JSON.parse(atob(importCode));
                
                if (confirm('ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿï¼ˆæ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã¯å‰Šé™¤ã•ã‚Œã¾ã™ï¼‰')) {
                    tradeHistory = syncData.tradeHistory || [];
                    portfolioData = syncData.portfolioData || [];
                    
                    saveData();
                    updateHistoryTable();
                    updatePortfolioTable();
                    updatePortfolioSummary();
                    updateStats();
                    
                    closeImportModal();
                    alert('ãƒ‡ãƒ¼ã‚¿ã®å¾©å…ƒãŒå®Œäº†ã—ã¾ã—ãŸï¼');
                }
            } catch (e) {
                alert('ç„¡åŠ¹ãªåŒæœŸã‚³ãƒ¼ãƒ‰ã§ã™ã€‚æ­£ã—ã„ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
            }
        }

        function copySyncCode() {
            const syncCode = document.getElementById('syncCode');
            syncCode.select();
            syncCode.setSelectionRange(0, 99999); // ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ
            
            try {
                document.execCommand('copy');
                alert('åŒæœŸã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
            } catch (e) {
                alert('æ‰‹å‹•ã§ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚');
            }
        }

        function closeSyncModal() {
            document.getElementById('syncModal').style.display = 'none';
        }

        function closeImportModal() {
            document.getElementById('importModal').style.display = 'none';
            document.getElementById('importCode').value = '';
        }

        // QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆï¼ˆç°¡æ˜“ç‰ˆï¼‰
        function generateQRCode(text) {
            return `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(text)}`;
        }
        function clearHistory() {
            if (confirm('ã™ã¹ã¦ã®å–å¼•å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
                tradeHistory = [];
                saveData();
                updateHistoryTable();
                updateStats();
                updateCharts();
                alert('å±¥æ­´ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚');
            }
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        document.getElementById('buyPrice').addEventListener('input', calculateTrade);
        document.getElementById('buyShares').addEventListener('input', calculateTrade);
        document.getElementById('sellPrice').addEventListener('input', calculateTrade);
        document.getElementById('profitPrice').addEventListener('input', calculateProfitLoss);
        document.getElementById('lossPrice').addEventListener('input', calculateProfitLoss);

        // åˆæœŸåŒ–
        window.addEventListener('load', function() {
            loadData();
            calculateTrade();
            updateStats();
        });
    </script>
</body>
</html>
