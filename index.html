<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ê†™ÂèñÂºïÊàêÁ∏æÁÆ°ÁêÜ</title>
    <meta name="theme-color" content="#3498db">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Ê†™ÂèñÂºïÊàêÁ∏æÁÆ°ÁêÜ">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 10px;
            background-color: #f5f5f5;
            font-size: 14px;
        }
        .container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 20px;
            font-size: 20px;
        }
        .section {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }
        .section h2 {
            color: #34495e;
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 16px;
        }
        .input-group {
            margin-bottom: 12px;
        }
        .input-group label {
            display: block;
            font-weight: bold;
            color: #555;
            margin-bottom: 5px;
            font-size: 13px;
        }
        .input-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .input-row input, .input-row select {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .input-row span {
            font-size: 12px;
            color: #666;
            min-width: 20px;
        }
        .result {
            background: #e8f5e8;
            padding: 12px;
            border-radius: 6px;
            margin-top: 15px;
            border-left: 4px solid #27ae60;
        }
        .result h3 {
            margin: 0 0 10px 0;
            color: #27ae60;
            font-size: 14px;
        }
        .result-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            padding: 3px 0;
            border-bottom: 1px solid #d5e8d5;
            font-size: 13px;
        }
        .result-item:last-child {
            border-bottom: none;
        }
        .positive {
            color: #27ae60;
            font-weight: bold;
        }
        .negative {
            color: #e74c3c;
            font-weight: bold;
        }
        .neutral {
            color: #34495e;
        }
        .stats-section {
            background: #e2e3e5;
            border-left-color: #6c757d;
        }
        .history-section {
            background: #fff3cd;
            border-left-color: #ffc107;
        }
        .tabs {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 2px solid #ddd;
        }
        .tab {
            flex: 1;
            padding: 10px;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-size: 12px;
            border-bottom: 2px solid transparent;
        }
        .tab.active {
            background: #3498db;
            color: white;
            border-bottom-color: #3498db;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .profit-loss-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }
        .profit-loss-item {
            background: white;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #ddd;
        }
        .profit-loss-item h4 {
            margin: 0 0 8px 0;
            font-size: 13px;
        }
        .profit-loss-item .amount {
            font-size: 16px;
            font-weight: bold;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }
        .stats-card {
            background: white;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #ddd;
            text-align: center;
        }
        .stats-card h4 {
            margin: 0 0 8px 0;
            font-size: 12px;
            color: #666;
        }
        .stats-card .value {
            font-size: 18px;
            font-weight: bold;
        }
        .add-button {
            background: #3498db;
            color: white;
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
            width: 100%;
            font-size: 14px;
        }
        .add-button:hover {
            background: #2980b9;
        }
        .record-button {
            background: #27ae60;
            color: white;
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
            width: 100%;
            font-size: 14px;
        }
        .record-button:hover {
            background: #229954;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 11px;
        }
        th, td {
            padding: 6px 4px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #3498db;
            color: white;
            font-size: 10px;
        }
        .remove-button {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 3px 6px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 10px;
        }
        .chart-container {
            margin-top: 15px;
            height: 300px;
        }
        .export-section {
            margin-top: 15px;
            padding: 10px;
            background: #d1ecf1;
            border-radius: 6px;
        }
        .export-button {
            background: #17a2b8;
            color: white;
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 12px;
        }
        /* LocalStorageÂØæÂøúÁâà */
        .save-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #27ae60;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="save-indicator" id="saveIndicator">üíæ ‰øùÂ≠ò„Åó„Åæ„Åó„Åü</div>
    
    <div class="container">
        <h1>üìä Ê†™ÂèñÂºïÊàêÁ∏æÁÆ°ÁêÜ</h1>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('simulation')">„Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥</button>
            <button class="tab" onclick="showTab('portfolio')">‰øùÊúâÊ†™</button>
            <button class="tab" onclick="showTab('history')">Â±•Ê≠¥</button>
            <button class="tab" onclick="showTab('stats')">ÊàêÁ∏æ</button>
            <button class="tab" onclick="showTab('chart')">„Ç∞„É©„Éï</button>
        </div>

        <!-- „Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥„Çø„ÉñÔºàÊóßÂèñÂºï„Çø„ÉñÔºâ -->
        <div id="simulation" class="tab-content active">
            <!-- Âü∫Êú¨ÊÉÖÂ†±ÂÖ•Âäõ -->
            <div class="section">
                <h2>üìù ÈäòÊüÑ„ÉªË≥ºÂÖ•ÊÉÖÂ†±</h2>
                <div class="input-group">
                    <label>ÈäòÊüÑÂêç</label>
                    <div class="input-row">
                        <input type="text" id="stockName" placeholder="‰æã: „Éà„É®„ÇøËá™ÂãïËªä">
                    </div>
                </div>
                <div class="input-group">
                    <label>Ë≥ºÂÖ•‰æ°Ê†º</label>
                    <div class="input-row">
                        <input type="number" id="buyPrice" placeholder="1000">
                        <span>ÂÜÜ</span>
                    </div>
                </div>
                <div class="input-group">
                    <label>Ë≥ºÂÖ•Ê†™Êï∞</label>
                    <div class="input-row">
                        <input type="number" id="buyShares" placeholder="100">
                        <span>Ê†™</span>
                    </div>
                </div>
                
                <div class="result">
                    <h3>üí∞ Ë≥ºÂÖ•ÈáëÈ°ç</h3>
                    <div class="result-item">
                        <span>Ë≥ºÂÖ•‰ª£Èáë:</span>
                        <span id="buyAmountOnly" class="neutral">0ÂÜÜ</span>
                    </div>
                    <div class="result-item">
                        <span>ÊâãÊï∞Êñô:</span>
                        <span id="buyFeeOnly" class="neutral">99ÂÜÜ</span>
                    </div>
                    <div class="result-item">
                        <span><strong>ÂêàË®àÊäïË≥áÈ°ç:</strong></span>
                        <span id="totalInvestment" class="neutral"><strong>0ÂÜÜ</strong></span>
                    </div>
                </div>
            </div>

            <!-- Âà©Á¢∫„ÉªÊêçÂàá„Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥ -->
            <div class="section">
                <h2>üéØ Âà©Á¢∫„ÉªÊêçÂàá„Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥</h2>
                <div class="input-group">
                    <label>Âà©Á¢∫‰æ°Ê†º</label>
                    <div class="input-row">
                        <input type="number" id="profitPrice" placeholder="1200">
                        <span>ÂÜÜ</span>
                    </div>
                </div>
                <div class="input-group">
                    <label>ÊêçÂàá‰æ°Ê†º</label>
                    <div class="input-row">
                        <input type="number" id="lossPrice" placeholder="900">
                        <span>ÂÜÜ</span>
                    </div>
                </div>
                
                <div class="profit-loss-grid">
                    <div class="profit-loss-item">
                        <h4>üü¢ Âà©Á¢∫ÊôÇ</h4>
                        <div class="amount positive" id="profitAmount">+0ÂÜÜ</div>
                        <div class="rate positive" id="profitAmountRate">+0%</div>
                    </div>
                    <div class="profit-loss-item">
                        <h4>üî¥ ÊêçÂàáÊôÇ</h4>
                        <div class="amount negative" id="lossAmount">-0ÂÜÜ</div>
                        <div class="rate negative" id="lossAmountRate">-0%</div>
                    </div>
                </div>
            </div>

            <!-- ÂÆüÈöõ„ÅÆÂ£≤Âç¥‰æ°Ê†º„Å®ÁµêÊûú -->
            <div class="section">
                <h2>üìà ÂÆüÈöõ„ÅÆÂèñÂºïÁµêÊûú</h2>
                <div class="input-group">
                    <label>ÂÆüÈöõ„ÅÆÂ£≤Âç¥‰æ°Ê†º</label>
                    <div class="input-row">
                        <input type="number" id="sellPrice" placeholder="ÂÆüÈöõ„Å´Â£≤Âç¥„Åó„Åü‰æ°Ê†º">
                        <span>ÂÜÜ</span>
                    </div>
                </div>
                
                <div class="result">
                    <h3>üíπ ÂèñÂºïÁµêÊûú</h3>
                    <div class="result-item">
                        <span>Â£≤Âç¥ÈáëÈ°ç:</span>
                        <span id="totalSellAmount" class="neutral">0ÂÜÜ</span>
                    </div>
                    <div class="result-item">
                        <span>ÊâãÊï∞ÊñôÂêàË®à:</span>
                        <span id="totalFees" class="neutral">198ÂÜÜ</span>
                    </div>
                    <div class="result-item">
                        <span>Á®éÈáë:</span>
                        <span id="totalTax" class="neutral">0ÂÜÜ</span>
                    </div>
                    <div class="result-item">
                        <span><strong>ÊúÄÁµÇÊêçÁõä:</strong></span>
                        <span id="finalProfit" class="neutral"><strong>0ÂÜÜ</strong></span>
                    </div>
                    <div class="result-item">
                        <span>ÊêçÁõäÁéá:</span>
                        <span id="profitRate" class="neutral">0%</span>
                    </div>
                    <div class="result-item">
                        <span>ÁõÆÊ®ô„Å®„ÅÆÂ∑Æ:</span>
                        <span id="targetDiff" class="neutral">-</span>
                    </div>
                </div>
                
                <button class="add-button" onclick="addToPortfolio()">üìà ‰øùÊúâÊ†™„Å´ËøΩÂä†</button>
                <button class="record-button" onclick="recordTrade()">üìù ÂèñÂºï„ÇíË®òÈå≤„Åó„Å¶ÂèçÁúÅÊùêÊñô„Å´</button>
            </div>
        </div>

        <!-- ‰øùÊúâÊ†™„Çø„Éñ -->
        <div id="portfolio" class="tab-content">
            <div class="section summary">
                <h2>üìä ‰øùÊúâÊ†™‰∏ÄË¶ß</h2>
                <table id="portfolioTable">
                    <thead>
                        <tr>
                            <th>ÈäòÊüÑ</th>
                            <th>Ë≥ºÂÖ•‰æ°Ê†º</th>
                            <th>Ê†™Êï∞</th>
                            <th>ÁèæÂú®‰æ°Ê†º</th>
                            <th>Âà©Á¢∫ÁõÆÊ®ô</th>
                            <th>ÊêçÂàá‰æ°Ê†º</th>
                            <th>Ë©ï‰æ°È°ç</th>
                            <th>ÊêçÁõä</th>
                            <th>ÊêçÁõäÁéá</th>
                            <th>Êìç‰Ωú</th>
                        </tr>
                    </thead>
                    <tbody id="portfolioBody">
                        <!-- ÂãïÁöÑ„Å´ËøΩÂä†„Åï„Çå„ÇãË°å -->
                    </tbody>
                </table>
                
                <div class="result">
                    <h3>üìä „Éù„Éº„Éà„Éï„Ç©„É™„Ç™ÂÖ®‰Ωì</h3>
                    <div class="result-item">
                        <span>Á∑èÊäïË≥áÈ°ç:</span>
                        <span id="totalPortfolioInvestment" class="neutral">0ÂÜÜ</span>
                    </div>
                    <div class="result-item">
                        <span>Á∑èË©ï‰æ°È°ç:</span>
                        <span id="totalPortfolioValue" class="neutral">0ÂÜÜ</span>
                    </div>
                    <div class="result-item">
                        <span><strong>Á∑èÊêçÁõä:</strong></span>
                        <span id="totalPortfolioProfit" class="neutral"><strong>0ÂÜÜ</strong></span>
                    </div>
                    <div class="result-item">
                        <span>Á∑èÊêçÁõäÁéá:</span>
                        <span id="totalPortfolioProfitRate" class="neutral">0%</span>
                    </div>
                </div>

                <!-- ÂÄãÂà•ÈäòÊüÑË©≥Á¥∞„Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥ -->
                <div class="section" id="selectedStockDetail" style="display: none;">
                    <h2 id="selectedStockName">üìà ÈäòÊüÑË©≥Á¥∞</h2>
                    <div class="profit-loss-grid">
                        <div class="profit-loss-item">
                            <h4>üü¢ Âà©Á¢∫ÊôÇ‰∫àÊÉ≥</h4>
                            <div class="amount positive" id="selectedProfitAmount">+0ÂÜÜ</div>
                            <div class="rate positive" id="selectedProfitRate">+0%</div>
                        </div>
                        <div class="profit-loss-item">
                            <h4>üî¥ ÊêçÂàáÊôÇ‰∫àÊÉ≥</h4>
                            <div class="amount negative" id="selectedLossAmount">-0ÂÜÜ</div>
                            <div class="rate negative" id="selectedLossRate">-0%</div>
                        </div>
                    </div>
                    <div class="profit-loss-grid">
                        <div class="profit-loss-item">
                            <h4>üìä ÁèæÂú®Áä∂Ê≥Å</h4>
                            <div class="amount neutral" id="selectedCurrentAmount">0ÂÜÜ</div>
                            <div class="rate neutral" id="selectedCurrentRate">0%</div>
                        </div>
                        <div class="profit-loss-item">
                            <h4>üéØ ÁõÆÊ®ô„Åæ„Åß</h4>
                            <div class="amount neutral" id="selectedTargetProgress">-</div>
                            <div class="rate neutral" id="selectedTargetPercent">-</div>
                        </div>
                    </div>
                    
                    <div class="input-group" style="margin-top: 15px;">
                        <label>Â£≤Âç¥‰æ°Ê†ºÂÖ•ÂäõÔºàÂèñÂºïË®òÈå≤Áî®Ôºâ</label>
                        <div class="input-row">
                            <input type="number" id="portfolioSellPrice" placeholder="ÂÆüÈöõ„ÅÆÂ£≤Âç¥‰æ°Ê†º">
                            <span>ÂÜÜ</span>
                            <button class="record-button" onclick="sellFromPortfolio()" style="margin: 0; width: auto; padding: 6px 12px;">Â£≤Âç¥Ë®òÈå≤</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- ÂèñÂºïÂ±•Ê≠¥„Çø„Éñ -->
        <div id="history" class="tab-content">
            <div class="section history-section">
                <h2>üìã ÂèñÂºïÂ±•Ê≠¥</h2>
                <table id="historyTable">
                    <thead>
                        <tr>
                            <th>Êó•‰ªò</th>
                            <th>ÈäòÊüÑ</th>
                            <th>Ê†™Êï∞</th>
                            <th>Ë≥ºÂÖ•‰æ°Ê†º</th>
                            <th>Â£≤Âç¥‰æ°Ê†º</th>
                            <th>ÊêçÁõä</th>
                            <th>ÊêçÁõäÁéá</th>
                            <th>Êìç‰Ωú</th>
                        </tr>
                    </thead>
                    <tbody id="historyBody">
                        <!-- ÂãïÁöÑ„Å´ËøΩÂä†„Åï„Çå„ÇãË°å -->
                    </tbody>
                </table>
                
                <div class="export-section">
                    <h4>üì§ „Éá„Éº„ÇøÁÆ°ÁêÜ</h4>
                    <button class="export-button" onclick="exportData()">CSV„Ç®„ÇØ„Çπ„Éù„Éº„Éà</button>
                    <button class="export-button" onclick="backupData()">„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó</button>
                    <button class="export-button" onclick="showImportModal()">„Éá„Éº„ÇøÂæ©ÂÖÉ</button>
                    <button class="export-button" onclick="syncData()">„Éá„Éê„Ç§„ÇπÈñìÂêåÊúü</button>
                    <button class="export-button" onclick="clearHistory()">Â±•Ê≠¥„ÇØ„É™„Ç¢</button>
                </div>

                <!-- „Éá„Éº„ÇøÂêåÊúü„É¢„Éº„ÉÄ„É´ -->
                <div id="syncModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 8px; max-width: 90%; width: 400px;">
                        <h3>üîÑ „Éá„Éê„Ç§„ÇπÈñìÂêåÊúü</h3>
                        <p>‰ª•‰∏ã„ÅÆ„Ç≥„Éº„Éâ„Çí„Ç≥„Éî„Éº„Åó„Å¶„ÄÅ‰ªñ„ÅÆ„Éá„Éê„Ç§„Çπ„Åß„Äå„Éá„Éº„ÇøÂæ©ÂÖÉ„Äç„Å´Ë≤º„Çä‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑÔºö</p>
                        <textarea id="syncCode" readonly style="width: 100%; height: 100px; margin: 10px 0; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;"></textarea>
                        <div style="text-align: center; margin-top: 15px;">
                            <button onclick="copySyncCode()" style="background: #27ae60; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin: 5px;">„Ç≥„Éº„Éâ„Çí„Ç≥„Éî„Éº</button>
                            <button onclick="closeSyncModal()" style="background: #95a5a6; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin: 5px;">Èñâ„Åò„Çã</button>
                        </div>
                    </div>
                </div>

                <!-- „Éá„Éº„Çø„Ç§„É≥„Éù„Éº„Éà„É¢„Éº„ÉÄ„É´ -->
                <div id="importModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 8px; max-width: 90%; width: 400px;">
                        <h3>üì• „Éá„Éº„ÇøÂæ©ÂÖÉ</h3>
                        <p>‰ªñ„ÅÆ„Éá„Éê„Ç§„Çπ„ÅßÁîüÊàê„Åó„ÅüÂêåÊúü„Ç≥„Éº„Éâ„ÇíË≤º„Çä‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑÔºö</p>
                        <textarea id="importCode" placeholder="ÂêåÊúü„Ç≥„Éº„Éâ„Çí„Åì„Åì„Å´Ë≤º„Çä‰ªò„Åë..." style="width: 100%; height: 100px; margin: 10px 0; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;"></textarea>
                        <div style="text-align: center; margin-top: 15px;">
                            <button onclick="importData()" style="background: #3498db; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin: 5px;">„Éá„Éº„Çø„ÇíÂæ©ÂÖÉ</button>
                            <button onclick="closeImportModal()" style="background: #95a5a6; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin: 5px;">„Ç≠„É£„É≥„Çª„É´</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ÊàêÁ∏æÁµ±Ë®à„Çø„Éñ -->
        <div id="stats" class="tab-content">
            <div class="section stats-section">
                <h2>üìä ÂèñÂºïÊàêÁ∏æÁµ±Ë®à</h2>
                
                <div class="stats-grid">
                    <div class="stats-card">
                        <h4>Á∑èÂèñÂºïÂõûÊï∞</h4>
                        <div class="value neutral" id="totalTrades">0Âõû</div>
                    </div>
                    <div class="stats-card">
                        <h4>ÂãùÁéá</h4>
                        <div class="value positive" id="winRate">0%</div>
                    </div>
                    <div class="stats-card">
                        <h4>Âãù„Å°ÂõûÊï∞</h4>
                        <div class="value positive" id="winCount">0Âõû</div>
                    </div>
                    <div class="stats-card">
                        <h4>Ë≤†„ÅëÂõûÊï∞</h4>
                        <div class="value negative" id="loseCount">0Âõû</div>
                    </div>
                    <div class="stats-card">
                        <h4>Á∑èÂà©Áõä</h4>
                        <div class="value positive" id="totalProfit">0ÂÜÜ</div>
                    </div>
                    <div class="stats-card">
                        <h4>Âπ≥ÂùáÂà©ÁõäÁéá</h4>
                        <div class="value neutral" id="avgProfitRate">0%</div>
                    </div>
                </div>

                <div class="result">
                    <h3>üìà ÊúàÂà•ÊàêÁ∏æ</h3>
                    <div class="result-item">
                        <span>‰ªäÊúà„ÅÆÂèñÂºï:</span>
                        <span id="monthlyTrades" class="neutral">0Âõû</span>
                    </div>
                    <div class="result-item">
                        <span>‰ªäÊúà„ÅÆÊêçÁõä:</span>
                        <span id="monthlyProfit" class="neutral">0ÂÜÜ</span>
                    </div>
                    <div class="result-item">
                        <span>‰ªäÊúà„ÅÆÂãùÁéá:</span>
                        <span id="monthlyWinRate" class="neutral">0%</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- „Ç∞„É©„Éï„Çø„Éñ -->
        <div id="chart" class="tab-content">
            <div class="section">
                <h2>üìà ÊêçÁõäÊé®Áßª„Ç∞„É©„Éï</h2>
                <div class="chart-container">
                    <canvas id="profitChart"></canvas>
                </div>
            </div>
            
            <div class="section">
                <h2>ü•ß ÂãùÊïóÊØîÁéá</h2>
                <div class="chart-container">
                    <canvas id="winLossChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        // „Éá„Éº„ÇøÁÆ°ÁêÜÔºàLocalStorage‰ΩøÁî®Ôºâ
        let tradeHistory = [];
        let portfolioData = [];
        let charts = {};
        let selectedStockId = null;

        // „Çø„ÉñÂàá„ÇäÊõø„Åà
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            if (tabName === 'chart') {
                setTimeout(updateCharts, 100);
            }
            if (tabName === 'stats') {
                updateStats();
            }
            if (tabName === 'portfolio') {
                updatePortfolioTable();
                updatePortfolioSummary();
            }
        }

        // ‰øùÂ≠ò„Ç§„É≥„Ç∏„Ç±„Éº„Çø„ÉºË°®Á§∫
        function showSaveIndicator() {
            const indicator = document.getElementById('saveIndicator');
            indicator.style.display = 'block';
            setTimeout(() => {
                indicator.style.display = 'none';
            }, 2000);
        }

        // „Éá„Éº„Çø‰øùÂ≠ò„ÉªË™≠„ÅøËæº„ÅøÔºàLocalStorage‰ΩøÁî®Ôºâ
        function saveData() {
            try {
                const data = {
                    history: tradeHistory,
                    portfolio: portfolioData,
                    lastSaved: new Date().toISOString()
                };
                localStorage.setItem('stockTradingData', JSON.stringify(data));
                showSaveIndicator();
            } catch (e) {
                console.warn('„Éá„Éº„Çø‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:', e);
            }
        }

        function loadData() {
            try {
                const saved = localStorage.getItem('stockTradingData');
                if (saved) {
                    const data = JSON.parse(saved);
                    tradeHistory = data.history || [];
                    portfolioData = data.portfolio || [];
                    updateHistoryTable();
                    updatePortfolioTable();
                    updatePortfolioSummary();
                    updateStats();
                }
            } catch (e) {
                console.warn('„Éá„Éº„ÇøË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:', e);
                tradeHistory = [];
                portfolioData = [];
            }
        }

        // ÂèñÂºïË®àÁÆóÔºàÊñ∞„Åó„ÅÑ„É¨„Ç§„Ç¢„Ç¶„ÉàÂØæÂøúÔºâ
        function calculateTrade() {
            const buyPrice = parseFloat(document.getElementById('buyPrice').value) || 0;
            const buyShares = parseInt(document.getElementById('buyShares').value) || 0;
            const sellPrice = parseFloat(document.getElementById('sellPrice').value) || 0;
            const profitPrice = parseFloat(document.getElementById('profitPrice').value) || 0;
            const lossPrice = parseFloat(document.getElementById('lossPrice').value) || 0;
            const buyFee = 99;

            // Ë≥ºÂÖ•ÊÉÖÂ†±„ÅÆË®àÁÆó
            const buyAmount = buyPrice * buyShares;
            const totalInvestmentAmount = buyAmount + buyFee;

            document.getElementById('buyAmountOnly').textContent = buyAmount.toLocaleString() + 'ÂÜÜ';
            document.getElementById('buyFeeOnly').textContent = buyFee.toLocaleString() + 'ÂÜÜ';
            document.getElementById('totalInvestment').textContent = totalInvestmentAmount.toLocaleString() + 'ÂÜÜ';

            // ÂÆüÈöõ„ÅÆÂèñÂºïÁµêÊûú
            if (sellPrice > 0 && buyShares > 0) {
                const sellAmount = sellPrice * buyShares;
                const totalFees = buyFee * 2;
                const grossProfit = sellAmount - buyAmount - totalFees;
                const tax = grossProfit > 0 ? grossProfit * 0.20315 : 0;
                const finalProfit = grossProfit - tax;
                const profitRate = buyAmount > 0 ? (finalProfit / buyAmount) * 100 : 0;

                document.getElementById('totalSellAmount').textContent = sellAmount.toLocaleString() + 'ÂÜÜ';
                document.getElementById('totalFees').textContent = totalFees.toLocaleString() + 'ÂÜÜ';
                document.getElementById('totalTax').textContent = tax.toLocaleString() + 'ÂÜÜ';
                document.getElementById('finalProfit').textContent = finalProfit.toLocaleString() + 'ÂÜÜ';
                document.getElementById('profitRate').textContent = profitRate.toFixed(2) + '%';

                // ÁõÆÊ®ô„Å®„ÅÆÂ∑Æ„ÇíË®àÁÆó
                let targetDiffText = '-';
                if (profitPrice > 0 && finalProfit > 0) {
                    // Âà©Á¢∫ÁõÆÊ®ô„Å®ÊØîËºÉ
                    const profitTarget = calculateProfitLossAmount(profitPrice, buyPrice, buyShares, buyFee);
                    const diff = finalProfit - profitTarget;
                    targetDiffText = `Âà©Á¢∫ÁõÆÊ®ô„Çà„Çä${diff >= 0 ? '+' : ''}${diff.toLocaleString()}ÂÜÜ`;
                } else if (lossPrice > 0 && finalProfit < 0) {
                    // ÊêçÂàáÁõÆÊ®ô„Å®ÊØîËºÉ
                    const lossTarget = calculateProfitLossAmount(lossPrice, buyPrice, buyShares, buyFee);
                    const diff = finalProfit - lossTarget;
                    targetDiffText = `ÊêçÂàáÁõÆÊ®ô„Çà„Çä${diff >= 0 ? '+' : ''}${diff.toLocaleString()}ÂÜÜ`;
                }
                document.getElementById('targetDiff').textContent = targetDiffText;

                // Ëâ≤ÂàÜ„Åë
                const profitElement = document.getElementById('finalProfit');
                const rateElement = document.getElementById('profitRate');
                const targetElement = document.getElementById('targetDiff');
                
                if (finalProfit > 0) {
                    profitElement.className = 'positive';
                    rateElement.className = 'positive';
                } else if (finalProfit < 0) {
                    profitElement.className = 'negative';
                    rateElement.className = 'negative';
                } else {
                    profitElement.className = 'neutral';
                    rateElement.className = 'neutral';
                }

                if (targetDiffText.includes('+')) {
                    targetElement.className = 'positive';
                } else if (targetDiffText.includes('-') && targetDiffText !== '-') {
                    targetElement.className = 'negative';
                } else {
                    targetElement.className = 'neutral';
                }
            } else {
                // Â£≤Âç¥‰æ°Ê†º„ÅåÊú™ÂÖ•Âäõ„ÅÆÂ†¥Âêà
                document.getElementById('totalSellAmount').textContent = '0ÂÜÜ';
                document.getElementById('totalFees').textContent = '198ÂÜÜ';
                document.getElementById('totalTax').textContent = '0ÂÜÜ';
                document.getElementById('finalProfit').textContent = '0ÂÜÜ';
                document.getElementById('profitRate').textContent = '0%';
                document.getElementById('targetDiff').textContent = '-';
            }

            calculateProfitLoss();
        }

        // Âà©Á¢∫„ÉªÊêçÂàáË®àÁÆó„ÅÆ„Éò„É´„Éë„ÉºÈñ¢Êï∞
        function calculateProfitLossAmount(targetPrice, buyPrice, buyShares, buyFee) {
            const buyAmount = buyPrice * buyShares;
            const sellAmount = targetPrice * buyShares;
            const totalFees = buyFee * 2;
            const grossProfit = sellAmount - buyAmount - totalFees;
            const tax = grossProfit > 0 ? grossProfit * 0.20315 : 0;
            return grossProfit - tax;
        }

        function calculateProfitLoss() {
            const buyPrice = parseFloat(document.getElementById('buyPrice').value) || 0;
            const buyShares = parseInt(document.getElementById('buyShares').value) || 0;
            const profitPrice = parseFloat(document.getElementById('profitPrice').value) || 0;
            const lossPrice = parseFloat(document.getElementById('lossPrice').value) || 0;
            const buyFee = 99;

            // Âà©Á¢∫Ë®àÁÆó
            if (profitPrice > 0 && buyShares > 0) {
                const profitFinal = calculateProfitLossAmount(profitPrice, buyPrice, buyShares, buyFee);
                const buyAmount = buyPrice * buyShares;
                const profitRate = buyAmount > 0 ? (profitFinal / buyAmount) * 100 : 0;

                document.getElementById('profitAmount').textContent = '+' + profitFinal.toLocaleString() + 'ÂÜÜ';
                document.getElementById('profitAmountRate').textContent = '+' + profitRate.toFixed(2) + '%';
            } else {
                document.getElementById('profitAmount').textContent = '+0ÂÜÜ';
                document.getElementById('profitAmountRate').textContent = '+0%';
            }

            // ÊêçÂàáË®àÁÆó
            if (lossPrice > 0 && buyShares > 0) {
                const lossFinal = calculateProfitLossAmount(lossPrice, buyPrice, buyShares, buyFee);
                const buyAmount = buyPrice * buyShares;
                const lossRate = buyAmount > 0 ? (lossFinal / buyAmount) * 100 : 0;

                document.getElementById('lossAmount').textContent = lossFinal.toLocaleString() + 'ÂÜÜ';
                document.getElementById('lossAmountRate').textContent = lossRate.toFixed(2) + '%';
            } else {
                document.getElementById('lossAmount').textContent = '-0ÂÜÜ';
                document.getElementById('lossAmountRate').textContent = '-0%';
            }
        }

        // ‰øùÊúâÊ†™„Å´ËøΩÂä†
        function addToPortfolio() {
            const stockName = document.getElementById('stockName').value || 'Êú™ÂÖ•Âäõ';
            const buyPrice = parseFloat(document.getElementById('buyPrice').value) || 0;
            const buyShares = parseInt(document.getElementById('buyShares').value) || 0;
            const profitPrice = parseFloat(document.getElementById('profitPrice').value) || 0;
            const lossPrice = parseFloat(document.getElementById('lossPrice').value) || 0;

            if (buyPrice > 0 && buyShares > 0) {
                const stock = {
                    id: Date.now(),
                    name: stockName,
                    buyPrice: buyPrice,
                    shares: buyShares,
                    currentPrice: buyPrice, // ÂàùÊúüÂÄ§„ÅØË≥ºÂÖ•‰æ°Ê†º
                    profitTarget: profitPrice,
                    lossTarget: lossPrice,
                    addedDate: new Date().toLocaleDateString('ja-JP')
                };

                portfolioData.push(stock);
                saveData();
                updatePortfolioTable();
                updatePortfolioSummary();

                // ÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„Çí„ÇØ„É™„Ç¢
                document.getElementById('stockName').value = '';
                document.getElementById('buyPrice').value = '';
                document.getElementById('buyShares').value = '';
                document.getElementById('profitPrice').value = '';
                document.getElementById('lossPrice').value = '';
                calculateTrade();

                alert('‰øùÊúâÊ†™„Å´ËøΩÂä†„Åó„Åæ„Åó„ÅüÔºÅ');
            } else {
                alert('ÈäòÊüÑÂêç„ÄÅË≥ºÂÖ•‰æ°Ê†º„ÄÅË≥ºÂÖ•Ê†™Êï∞„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
            }
        }

        // „Éù„Éº„Éà„Éï„Ç©„É™„Ç™„ÉÜ„Éº„Éñ„É´Êõ¥Êñ∞
        function updatePortfolioTable() {
            const tbody = document.getElementById('portfolioBody');
            tbody.innerHTML = '';

            portfolioData.forEach(stock => {
                const investmentAmount = stock.buyPrice * stock.shares + 99; // ÊâãÊï∞ÊñôËæº„Åø
                const currentValue = stock.currentPrice * stock.shares;
                const profit = currentValue - investmentAmount;
                const profitRate = (profit / investmentAmount) * 100;

                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${stock.name}</td>
                    <td>¬•${stock.buyPrice.toLocaleString()}</td>
                    <td>${stock.shares}</td>
                    <td><input type="number" value="${stock.currentPrice}" onchange="updateCurrentPrice(${stock.id}, this.value)" style="width: 70px; padding: 4px; font-size: 12px;"></td>
                    <td>¬•${stock.profitTarget.toLocaleString()}</td>
                    <td>¬•${stock.lossTarget.toLocaleString()}</td>
                    <td>¬•${currentValue.toLocaleString()}</td>
                    <td class="${profit >= 0 ? 'positive' : 'negative'}">¬•${profit.toLocaleString()}</td>
                    <td class="${profitRate >= 0 ? 'positive' : 'negative'}">${profitRate.toFixed(2)}%</td>
                    <td>
                        <button onclick="selectStock(${stock.id})" style="background: #3498db; color: white; border: none; padding: 3px 6px; border-radius: 3px; cursor: pointer; font-size: 10px; margin: 1px;">Ë©≥Á¥∞</button>
                        <button onclick="removeFromPortfolio(${stock.id})" class="remove-button">ÂâäÈô§</button>
                    </td>
                `;
            });
        }

        // ÁèæÂú®‰æ°Ê†ºÊõ¥Êñ∞
        function updateCurrentPrice(id, newPrice) {
            const stock = portfolioData.find(s => s.id === id);
            if (stock) {
                stock.currentPrice = parseFloat(newPrice) || 0;
                saveData();
                updatePortfolioTable();
                updatePortfolioSummary();
                if (selectedStockId === id) {
                    updateSelectedStockDetail();
                }
            }
        }

        // „Éù„Éº„Éà„Éï„Ç©„É™„Ç™„Çµ„Éû„É™„ÉºÊõ¥Êñ∞
        function updatePortfolioSummary() {
            const totalInvestment = portfolioData.reduce((sum, stock) => sum + (stock.buyPrice * stock.shares + 99), 0);
            const totalValue = portfolioData.reduce((sum, stock) => sum + (stock.currentPrice * stock.shares), 0);
            const totalProfit = totalValue - totalInvestment;
            const totalProfitRate = totalInvestment > 0 ? (totalProfit / totalInvestment) * 100 : 0;

            document.getElementById('totalPortfolioInvestment').textContent = totalInvestment.toLocaleString() + 'ÂÜÜ';
            document.getElementById('totalPortfolioValue').textContent = totalValue.toLocaleString() + 'ÂÜÜ';
            document.getElementById('totalPortfolioProfit').textContent = totalProfit.toLocaleString() + 'ÂÜÜ';
            document.getElementById('totalPortfolioProfitRate').textContent = totalProfitRate.toFixed(2) + '%';

            // Ëâ≤ÂàÜ„Åë
            const profitElement = document.getElementById('totalPortfolioProfit');
            const rateElement = document.getElementById('totalPortfolioProfitRate');
            
            if (totalProfit > 0) {
                profitElement.className = 'positive';
                rateElement.className = 'positive';
            } else if (totalProfit < 0) {
                profitElement.className = 'negative';
                rateElement.className = 'negative';
            } else {
                profitElement.className = 'neutral';
                rateElement.className = 'neutral';
            }
        }

        // ÈäòÊüÑÈÅ∏Êäû
        function selectStock(id) {
            selectedStockId = id;
            updateSelectedStockDetail();
            document.getElementById('selectedStockDetail').style.display = 'block';
        }

        // ÈÅ∏Êäû„Åï„Çå„ÅüÈäòÊüÑ„ÅÆË©≥Á¥∞Êõ¥Êñ∞
        function updateSelectedStockDetail() {
            const stock = portfolioData.find(s => s.id === selectedStockId);
            if (!stock) return;

            document.getElementById('selectedStockName').textContent = `üìà ${stock.name} Ë©≥Á¥∞„Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥`;

            const investmentAmount = stock.buyPrice * stock.shares + 99;
            const currentValue = stock.currentPrice * stock.shares;
            const currentProfit = currentValue - investmentAmount;
            const currentProfitRate = (currentProfit / investmentAmount) * 100;

            // Âà©Á¢∫ÊôÇË®àÁÆó
            const profitValue = stock.profitTarget * stock.shares;
            const profitAmount = profitValue - investmentAmount - 99;
            const profitTax = profitAmount > 0 ? profitAmount * 0.20315 : 0;
            const finalProfitAmount = profitAmount - profitTax;
            const finalProfitRate = (finalProfitAmount / investmentAmount) * 100;

            // ÊêçÂàáÊôÇË®àÁÆó
            const lossValue = stock.lossTarget * stock.shares;
            const lossAmount = lossValue - investmentAmount - 99;
            const lossTax = lossAmount > 0 ? lossAmount * 0.20315 : 0;
            const finalLossAmount = lossAmount - lossTax;
            const finalLossRate = (finalLossAmount / investmentAmount) * 100;

            // ÁõÆÊ®ô„Åæ„Åß„ÅÆÈÄ≤Êçó
            let targetProgress = '-';
            let targetPercent = '-';
            if (currentProfit > 0 && stock.profitTarget > 0) {
                const progressToProfit = (stock.currentPrice - stock.buyPrice) / (stock.profitTarget - stock.buyPrice) * 100;
                targetProgress = `Âà©Á¢∫„Åæ„Åß${(100 - progressToProfit).toFixed(1)}%`;
                targetPercent = `„ÅÇ„Å®¬•${((stock.profitTarget - stock.currentPrice) * stock.shares).toLocaleString()}`;
            } else if (currentProfit < 0 && stock.lossTarget > 0) {
                const progressToLoss = Math.abs((stock.currentPrice - stock.buyPrice) / (stock.lossTarget - stock.buyPrice)) * 100;
                targetProgress = `ÊêçÂàá„Åæ„Åß${(100 - progressToLoss).toFixed(1)}%`;
                targetPercent = `„ÅÇ„Å®¬•${Math.abs((stock.lossTarget - stock.currentPrice) * stock.shares).toLocaleString()}`;
            }

            document.getElementById('selectedProfitAmount').textContent = '+' + finalProfitAmount.toLocaleString() + 'ÂÜÜ';
            document.getElementById('selectedProfitRate').textContent = '+' + finalProfitRate.toFixed(2) + '%';
            document.getElementById('selectedLossAmount').textContent = finalLossAmount.toLocaleString() + 'ÂÜÜ';
            document.getElementById('selectedLossRate').textContent = finalLossRate.toFixed(2) + '%';
            document.getElementById('selectedCurrentAmount').textContent = currentProfit.toLocaleString() + 'ÂÜÜ';
            document.getElementById('selectedCurrentRate').textContent = currentProfitRate.toFixed(2) + '%';
            document.getElementById('selectedTargetProgress').textContent = targetProgress;
            document.getElementById('selectedTargetPercent').textContent = targetPercent;

            // Ëâ≤ÂàÜ„Åë
            document.getElementById('selectedCurrentAmount').className = currentProfit >= 0 ? 'positive' : 'negative';
            document.getElementById('selectedCurrentRate').className = currentProfitRate >= 0 ? 'positive' : 'negative';
        }

        // „Éù„Éº„Éà„Éï„Ç©„É™„Ç™„Åã„ÇâÂ£≤Âç¥
        function sellFromPortfolio() {
            if (!selectedStockId) {
                alert('ÈäòÊüÑ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }

            const sellPrice = parseFloat(document.getElementById('portfolioSellPrice').value);
            if (!sellPrice || sellPrice <= 0) {
                alert('Â£≤Âç¥‰æ°Ê†º„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }

            const stock = portfolioData.find(s => s.id === selectedStockId);
            if (!stock) return;

            // ÂèñÂºïÂ±•Ê≠¥„Å´ËøΩÂä†
            const investmentAmount = stock.buyPrice * stock.shares + 99;
            const sellAmount = sellPrice * stock.shares;
            const totalFees = 99 * 2;
            const grossProfit = sellAmount - (stock.buyPrice * stock.shares) - totalFees;
            const tax = grossProfit > 0 ? grossProfit * 0.20315 : 0;
            const finalProfit = grossProfit - tax;
            const profitRate = (finalProfit / (stock.buyPrice * stock.shares)) * 100;

            const trade = {
                id: Date.now(),
                date: new Date().toLocaleDateString('ja-JP'),
                stockName: stock.name,
                buyPrice: stock.buyPrice,
                sellPrice: sellPrice,
                shares: stock.shares,
                profit: finalProfit,
                profitRate: profitRate,
                isWin: finalProfit > 0,
                profitTarget: stock.profitTarget,
                lossTarget: stock.lossTarget
            };

            tradeHistory.push(trade);

            // „Éù„Éº„Éà„Éï„Ç©„É™„Ç™„Åã„ÇâÂâäÈô§
            portfolioData = portfolioData.filter(s => s.id !== selectedStockId);
            selectedStockId = null;
            document.getElementById('selectedStockDetail').style.display = 'none';
            document.getElementById('portfolioSellPrice').value = '';

            saveData();
            updatePortfolioTable();
            updatePortfolioSummary();
            updateHistoryTable();
            updateStats();

            alert(`${stock.name}„ÇíÂ£≤Âç¥Ë®òÈå≤„Åó„Åæ„Åó„ÅüÔºÅ`);
        }

        // „Éù„Éº„Éà„Éï„Ç©„É™„Ç™„Åã„ÇâÂâäÈô§
        function removeFromPortfolio(id) {
            if (confirm('„Åì„ÅÆÈäòÊüÑ„Çí‰øùÊúâÊ†™„Åã„ÇâÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                portfolioData = portfolioData.filter(stock => stock.id !== id);
                if (selectedStockId === id) {
                    selectedStockId = null;
                    document.getElementById('selectedStockDetail').style.display = 'none';
                }
                saveData();
                updatePortfolioTable();
                updatePortfolioSummary();
            }
        }
        function recordTrade() {
            const stockName = document.getElementById('stockName').value || 'Êú™ÂÖ•Âäõ';
            const buyPrice = parseFloat(document.getElementById('buyPrice').value) || 0;
            const buyShares = parseInt(document.getElementById('buyShares').value) || 0;
            const sellPrice = parseFloat(document.getElementById('sellPrice').value) || 0;

            if (buyPrice > 0 && buyShares > 0 && sellPrice > 0) {
                const buyAmount = buyPrice * buyShares;
                const sellAmount = sellPrice * buyShares;
                const totalFees = 99 * 2;
                const grossProfit = sellAmount - buyAmount - totalFees;
                const tax = grossProfit > 0 ? grossProfit * 0.20315 : 0;
                const finalProfit = grossProfit - tax;
                const profitRate = (finalProfit / buyAmount) * 100;

                const trade = {
                    id: Date.now(),
                    date: new Date().toLocaleDateString('ja-JP'),
                    stockName: stockName,
                    buyPrice: buyPrice,
                    sellPrice: sellPrice,
                    shares: buyShares,
                    profit: finalProfit,
                    profitRate: profitRate,
                    isWin: finalProfit > 0
                };

                tradeHistory.push(trade);
                saveData();
                updateHistoryTable();
                updateStats();

                // ÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„Çí„ÇØ„É™„Ç¢
                document.getElementById('stockName').value = '';
                document.getElementById('buyPrice').value = '';
                document.getElementById('buyShares').value = '';
                document.getElementById('sellPrice').value = '';
                calculateTrade();

                alert('ÂèñÂºï„ÇíË®òÈå≤„Åó„Åæ„Åó„ÅüÔºÅ');
            } else {
                alert('„Åô„Åπ„Å¶„ÅÆÈ†ÖÁõÆ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
            }
        }

        // Â±•Ê≠¥„ÉÜ„Éº„Éñ„É´Êõ¥Êñ∞
        function updateHistoryTable() {
            const tbody = document.getElementById('historyBody');
            tbody.innerHTML = '';

            tradeHistory.slice().reverse().forEach(trade => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${trade.date}</td>
                    <td>${trade.stockName}</td>
                    <td>${trade.shares}</td>
                    <td>¬•${trade.buyPrice.toLocaleString()}</td>
                    <td>¬•${trade.sellPrice.toLocaleString()}</td>
                    <td class="${trade.profit >= 0 ? 'positive' : 'negative'}">¬•${trade.profit.toLocaleString()}</td>
                    <td class="${trade.profitRate >= 0 ? 'positive' : 'negative'}">${trade.profitRate.toFixed(2)}%</td>
                    <td><button onclick="removeTrade(${trade.id})" class="remove-button">ÂâäÈô§</button></td>
                `;
            });
        }

        // Áµ±Ë®àÊõ¥Êñ∞
        function updateStats() {
            const totalTrades = tradeHistory.length;
            const wins = tradeHistory.filter(t => t.isWin).length;
            const losses = totalTrades - wins;
            const winRate = totalTrades > 0 ? (wins / totalTrades) * 100 : 0;
            const totalProfit = tradeHistory.reduce((sum, t) => sum + t.profit, 0);
            const avgProfitRate = totalTrades > 0 ? tradeHistory.reduce((sum, t) => sum + t.profitRate, 0) / totalTrades : 0;

            // ‰ªäÊúà„ÅÆ„Éá„Éº„Çø
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const monthlyTrades = tradeHistory.filter(t => {
                const tradeDate = new Date(t.date);
                return tradeDate.getMonth() === currentMonth && tradeDate.getFullYear() === currentYear;
            });
            const monthlyWins = monthlyTrades.filter(t => t.isWin).length;
            const monthlyWinRate = monthlyTrades.length > 0 ? (monthlyWins / monthlyTrades.length) * 100 : 0;
            const monthlyProfit = monthlyTrades.reduce((sum, t) => sum + t.profit, 0);

            document.getElementById('totalTrades').textContent = totalTrades + 'Âõû';
            document.getElementById('winRate').textContent = winRate.toFixed(1) + '%';
            document.getElementById('winCount').textContent = wins + 'Âõû';
            document.getElementById('loseCount').textContent = losses + 'Âõû';
            document.getElementById('totalProfit').textContent = totalProfit.toLocaleString() + 'ÂÜÜ';
            document.getElementById('avgProfitRate').textContent = avgProfitRate.toFixed(2) + '%';
            
            document.getElementById('monthlyTrades').textContent = monthlyTrades.length + 'Âõû';
            document.getElementById('monthlyProfit').textContent = monthlyProfit.toLocaleString() + 'ÂÜÜ';
            document.getElementById('monthlyWinRate').textContent = monthlyWinRate.toFixed(1) + '%';

            // Ëâ≤ÂàÜ„Åë
            document.getElementById('totalProfit').className = totalProfit >= 0 ? 'positive' : 'negative';
            document.getElementById('monthlyProfit').className = monthlyProfit >= 0 ? 'positive' : 'negative';
        }

        // „Ç∞„É©„ÉïÊõ¥Êñ∞
        function updateCharts() {
            updateProfitChart();
            updateWinLossChart();
        }

        function updateProfitChart() {
            const ctx = document.getElementById('profitChart').getContext('2d');
            
            if (charts.profit) {
                charts.profit.destroy();
            }

            // Á¥ØÁ©çÊêçÁõä„ÅÆ„Éá„Éº„Çø‰ΩúÊàê
            let cumulativeProfit = 0;
            const data = tradeHistory.map((trade, index) => {
                cumulativeProfit += trade.profit;
                return {
                    x: index + 1,
                    y: cumulativeProfit
                };
            });

            charts.profit = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'Á¥ØÁ©çÊêçÁõä (ÂÜÜ)',
                        data: data,
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        tension: 0.2,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'ÂèñÂºïÂõûÊï∞'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Á¥ØÁ©çÊêçÁõä (ÂÜÜ)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        function updateWinLossChart() {
            const ctx = document.getElementById('winLossChart').getContext('2d');
            
            if (charts.winLoss) {
                charts.winLoss.destroy();
            }

            const wins = tradeHistory.filter(t => t.isWin).length;
            const losses = tradeHistory.length - wins;

            if (wins === 0 && losses === 0) {
                // „Éá„Éº„Çø„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ„Ç∞„É©„Éï„ÇíË°®Á§∫„Åó„Å™„ÅÑ
                return;
            }

            charts.winLoss = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Âãù„Å°', 'Ë≤†„Åë'],
                    datasets: [{
                        data: [wins, losses],
                        backgroundColor: ['#27ae60', '#e74c3c'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // ÂèñÂºïÂâäÈô§
        function removeTrade(id) {
            if (confirm('„Åì„ÅÆÂèñÂºï„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                tradeHistory = tradeHistory.filter(trade => trade.id !== id);
                saveData();
                updateHistoryTable();
                updateStats();
            }
        }

        // „Éá„Éº„Çø„Ç®„ÇØ„Çπ„Éù„Éº„Éà
        function exportData() {
            if (tradeHistory.length === 0) {
                alert('„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åô„Çã„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ');
                return;
            }

            const csvContent = "data:text/csv;charset=utf-8," 
                + "Êó•‰ªò,ÈäòÊüÑÂêç,Ë≥ºÂÖ•‰æ°Ê†º,Â£≤Âç¥‰æ°Ê†º,Ê†™Êï∞,ÊêçÁõä,ÊêçÁõäÁéá\n"
                + tradeHistory.map(trade => 
                    `${trade.date},${trade.stockName},${trade.buyPrice},${trade.sellPrice},${trade.shares},${trade.profit},${trade.profitRate}%`
                ).join("\n");

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `Ê†™ÂèñÂºïÂ±•Ê≠¥_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó
        function backupData() {
            if (tradeHistory.length === 0) {
                alert('„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Åô„Çã„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ');
                return;
            }

            const backupData = {
                version: '1.0',
                exportDate: new Date().toISOString(),
                tradeHistory: tradeHistory
            };

            const dataStr = JSON.stringify(backupData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement("a");
            link.href = URL.createObjectURL(dataBlob);
            link.download = `Ê†™ÂèñÂºï„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert('„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Éï„Ç°„Ç§„É´„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Åæ„Åó„Åü„ÄÇ');
        }

        // „Éá„Éº„ÇøÂêåÊúüÊ©üËÉΩ
        function syncData() {
            const syncData = {
                version: '1.0',
                timestamp: new Date().toISOString(),
                tradeHistory: tradeHistory,
                portfolioData: portfolioData
            };

            const syncCode = btoa(JSON.stringify(syncData));
            document.getElementById('syncCode').value = syncCode;
            document.getElementById('syncModal').style.display = 'block';
        }

        function showImportModal() {
            document.getElementById('importModal').style.display = 'block';
        }

        function importData() {
            const importCode = document.getElementById('importCode').value.trim();
            if (!importCode) {
                alert('ÂêåÊúü„Ç≥„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }

            try {
                const syncData = JSON.parse(atob(importCode));
                
                if (confirm('ÁèæÂú®„ÅÆ„Éá„Éº„Çø„Çí‰∏äÊõ∏„Åç„Åó„Åæ„Åô„ÅãÔºüÔºàÊó¢Â≠ò„Éá„Éº„Çø„ÅØÂâäÈô§„Åï„Çå„Åæ„ÅôÔºâ')) {
                    tradeHistory = syncData.tradeHistory || [];
                    portfolioData = syncData.portfolioData || [];
                    
                    saveData();
                    updateHistoryTable();
                    updatePortfolioTable();
                    updatePortfolioSummary();
                    updateStats();
                    
                    closeImportModal();
                    alert('„Éá„Éº„Çø„ÅÆÂæ©ÂÖÉ„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅ');
                }
            } catch (e) {
                alert('ÁÑ°Âäπ„Å™ÂêåÊúü„Ç≥„Éº„Éâ„Åß„Åô„ÄÇÊ≠£„Åó„ÅÑ„Ç≥„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
            }
        }

        function copySyncCode() {
            const syncCode = document.getElementById('syncCode');
            syncCode.select();
            syncCode.setSelectionRange(0, 99999); // „É¢„Éê„Ç§„É´ÂØæÂøú
            
            try {
                document.execCommand('copy');
                alert('ÂêåÊúü„Ç≥„Éº„Éâ„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ');
            } catch (e) {
                alert('ÊâãÂãï„Åß„Ç≥„Éº„Éâ„Çí„Ç≥„Éî„Éº„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
            }
        }

        function closeSyncModal() {
            document.getElementById('syncModal').style.display = 'none';
        }

        function closeImportModal() {
            document.getElementById('importModal').style.display = 'none';
            document.getElementById('importCode').value = '';
        }

        // QR„Ç≥„Éº„ÉâÁîüÊàêÔºàÁ∞°ÊòìÁâàÔºâ
        function generateQRCode(text) {
            return `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(text)}`;
        }
        function clearHistory() {
            if (confirm('„Åô„Åπ„Å¶„ÅÆÂèñÂºïÂ±•Ê≠¥„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü„Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„Çì„ÄÇ')) {
                tradeHistory = [];
                saveData();
                updateHistoryTable();
                updateStats();
                updateCharts();
                alert('Â±•Ê≠¥„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„Åü„ÄÇ');
            }
        }

        // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
        document.getElementById('buyPrice').addEventListener('input', calculateTrade);
        document.getElementById('buyShares').addEventListener('input', calculateTrade);
        document.getElementById('sellPrice').addEventListener('input', calculateTrade);
        document.getElementById('profitPrice').addEventListener('input', calculateProfitLoss);
        document.getElementById('lossPrice').addEventListener('input', calculateProfitLoss);

        // ÂàùÊúüÂåñ
        window.addEventListener('load', function() {
            loadData();
            calculateTrade();
            updateStats();
        });
    </script>
</body>
</html>
