<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ ªå–å¼•æˆç¸¾ç®¡ç†</title>
    <meta name="theme-color" content="#3498db">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="æ ªå–å¼•æˆç¸¾ç®¡ç†">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 10px;
            background-color: #f5f5f5;
            font-size: 14px;
        }
        .container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 20px;
            font-size: 20px;
        }
        .section {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }
        .section h2 {
            color: #34495e;
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 16px;
        }
        .input-group {
            margin-bottom: 12px;
        }
        .input-group label {
            display: block;
            font-weight: bold;
            color: #555;
            margin-bottom: 5px;
            font-size: 13px;
        }
        .input-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .input-row input, .input-row select {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .input-row span {
            font-size: 12px;
            color: #666;
            min-width: 20px;
        }
        .result {
            background: #e8f5e8;
            padding: 12px;
            border-radius: 6px;
            margin-top: 15px;
            border-left: 4px solid #27ae60;
        }
        .result h3 {
            margin: 0 0 10px 0;
            color: #27ae60;
            font-size: 14px;
        }
        .result-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            padding: 3px 0;
            border-bottom: 1px solid #d5e8d5;
            font-size: 13px;
        }
        .result-item:last-child {
            border-bottom: none;
        }
        .positive {
            color: #27ae60;
            font-weight: bold;
        }
        .negative {
            color: #e74c3c;
            font-weight: bold;
        }
        .neutral {
            color: #34495e;
        }
        .stats-section {
            background: #e2e3e5;
            border-left-color: #6c757d;
        }
        .history-section {
            background: #fff3cd;
            border-left-color: #ffc107;
        }
        .tabs {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 2px solid #ddd;
        }
        .tab {
            flex: 1;
            padding: 10px;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-size: 12px;
            border-bottom: 2px solid transparent;
        }
        .tab.active {
            background: #3498db;
            color: white;
            border-bottom-color: #3498db;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .profit-loss-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }
        .profit-loss-item {
            background: white;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #ddd;
        }
        .profit-loss-item h4 {
            margin: 0 0 8px 0;
            font-size: 13px;
        }
        .profit-loss-item .amount {
            font-size: 16px;
            font-weight: bold;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }
        .stats-card {
            background: white;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #ddd;
            text-align: center;
        }
        .stats-card h4 {
            margin: 0 0 8px 0;
            font-size: 12px;
            color: #666;
        }
        .stats-card .value {
            font-size: 18px;
            font-weight: bold;
        }
        .add-button {
            background: #3498db;
            color: white;
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
            width: 100%;
            font-size: 14px;
        }
        .add-button:hover {
            background: #2980b9;
        }
        .record-button {
            background: #27ae60;
            color: white;
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
            width: 100%;
            font-size: 14px;
        }
        .record-button:hover {
            background: #229954;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 11px;
        }
        th, td {
            padding: 6px 4px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #3498db;
            color: white;
            font-size: 10px;
        }
        .remove-button {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 3px 6px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 10px;
        }
        .chart-container {
            margin-top: 15px;
            height: 300px;
        }
        .export-section {
            margin-top: 15px;
            padding: 10px;
            background: #d1ecf1;
            border-radius: 6px;
        }
        .export-button {
            background: #17a2b8;
            color: white;
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 12px;
        }
        /* LocalStorageå¯¾å¿œç‰ˆ */
        .save-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #27ae60;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="save-indicator" id="saveIndicator">ğŸ’¾ ä¿å­˜ã—ã¾ã—ãŸ</div>
    
    <div class="container">
        <h1>ğŸ“Š æ ªå–å¼•æˆç¸¾ç®¡ç†</h1>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('trade')">å–å¼•</button>
            <button class="tab" onclick="showTab('history')">å±¥æ­´</button>
            <button class="tab" onclick="showTab('stats')">æˆç¸¾</button>
            <button class="tab" onclick="showTab('chart')">ã‚°ãƒ©ãƒ•</button>
        </div>

        <!-- å–å¼•ã‚¿ãƒ– -->
        <div id="trade" class="tab-content active">
            <div class="section">
                <h2>ğŸ”¢ å–å¼•è¨ˆç®—</h2>
                <div class="input-group">
                    <label>éŠ˜æŸ„å</label>
                    <div class="input-row">
                        <input type="text" id="stockName" placeholder="ä¾‹: ãƒˆãƒ¨ã‚¿è‡ªå‹•è»Š">
                    </div>
                </div>
                <div class="input-group">
                    <label>è³¼å…¥ä¾¡æ ¼</label>
                    <div class="input-row">
                        <input type="number" id="buyPrice" placeholder="1000">
                        <span>å††</span>
                    </div>
                </div>
                <div class="input-group">
                    <label>è³¼å…¥æ ªæ•°</label>
                    <div class="input-row">
                        <input type="number" id="buyShares" placeholder="100">
                        <span>æ ª</span>
                    </div>
                </div>
                <div class="input-group">
                    <label>å£²å´ä¾¡æ ¼</label>
                    <div class="input-row">
                        <input type="number" id="sellPrice" placeholder="1100">
                        <span>å††</span>
                    </div>
                </div>
                
                <div class="result">
                    <h3>ğŸ“ˆ å–å¼•çµæœ</h3>
                    <div class="result-item">
                        <span>è³¼å…¥é‡‘é¡:</span>
                        <span id="totalBuyAmount" class="neutral">0å††</span>
                    </div>
                    <div class="result-item">
                        <span>å£²å´é‡‘é¡:</span>
                        <span id="totalSellAmount" class="neutral">0å††</span>
                    </div>
                    <div class="result-item">
                        <span>æ‰‹æ•°æ–™:</span>
                        <span id="totalFees" class="neutral">0å††</span>
                    </div>
                    <div class="result-item">
                        <span>ç¨é‡‘:</span>
                        <span id="totalTax" class="neutral">0å††</span>
                    </div>
                    <div class="result-item">
                        <span><strong>æœ€çµ‚æç›Š:</strong></span>
                        <span id="finalProfit" class="neutral"><strong>0å††</strong></span>
                    </div>
                    <div class="result-item">
                        <span>æç›Šç‡:</span>
                        <span id="profitRate" class="neutral">0%</span>
                    </div>
                </div>
                
                <button class="record-button" onclick="recordTrade()">ğŸ“ å–å¼•ã‚’è¨˜éŒ²</button>
            </div>

            <!-- åˆ©ç¢ºãƒ»æåˆ‡è¨ˆç®— -->
            <div class="section">
                <h2>ğŸ¯ åˆ©ç¢ºãƒ»æåˆ‡è¨ˆç®—</h2>
                <div class="input-group">
                    <label>åˆ©ç¢ºä¾¡æ ¼</label>
                    <div class="input-row">
                        <input type="number" id="profitPrice" placeholder="1200">
                        <span>å††</span>
                    </div>
                </div>
                <div class="input-group">
                    <label>æåˆ‡ä¾¡æ ¼</label>
                    <div class="input-row">
                        <input type="number" id="lossPrice" placeholder="900">
                        <span>å††</span>
                    </div>
                </div>
                
                <div class="profit-loss-grid">
                    <div class="profit-loss-item">
                        <h4>ğŸŸ¢ åˆ©ç¢ºæ™‚</h4>
                        <div class="amount positive" id="profitAmount">+0å††</div>
                        <div class="rate positive" id="profitAmountRate">+0%</div>
                    </div>
                    <div class="profit-loss-item">
                        <h4>ğŸ”´ æåˆ‡æ™‚</h4>
                        <div class="amount negative" id="lossAmount">-0å††</div>
                        <div class="rate negative" id="lossAmountRate">-0%</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å–å¼•å±¥æ­´ã‚¿ãƒ– -->
        <div id="history" class="tab-content">
            <div class="section history-section">
                <h2>ğŸ“‹ å–å¼•å±¥æ­´</h2>
                <table id="historyTable">
                    <thead>
                        <tr>
                            <th>æ—¥ä»˜</th>
                            <th>éŠ˜æŸ„</th>
                            <th>æ ªæ•°</th>
                            <th>è³¼å…¥ä¾¡æ ¼</th>
                            <th>å£²å´ä¾¡æ ¼</th>
                            <th>æç›Š</th>
                            <th>æç›Šç‡</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="historyBody">
                        <!-- å‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹è¡Œ -->
                    </tbody>
                </table>
                
                <div class="export-section">
                    <h4>ğŸ“¤ ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h4>
                    <button class="export-button" onclick="exportData()">CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                    <button class="export-button" onclick="clearHistory()">å±¥æ­´ã‚¯ãƒªã‚¢</button>
                    <button class="export-button" onclick="backupData()">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</button>
                </div>
            </div>
        </div>

        <!-- æˆç¸¾çµ±è¨ˆã‚¿ãƒ– -->
        <div id="stats" class="tab-content">
            <div class="section stats-section">
                <h2>ğŸ“Š å–å¼•æˆç¸¾çµ±è¨ˆ</h2>
                
                <div class="stats-grid">
                    <div class="stats-card">
                        <h4>ç·å–å¼•å›æ•°</h4>
                        <div class="value neutral" id="totalTrades">0å›</div>
                    </div>
                    <div class="stats-card">
                        <h4>å‹ç‡</h4>
                        <div class="value positive" id="winRate">0%</div>
                    </div>
                    <div class="stats-card">
                        <h4>å‹ã¡å›æ•°</h4>
                        <div class="value positive" id="winCount">0å›</div>
                    </div>
                    <div class="stats-card">
                        <h4>è² ã‘å›æ•°</h4>
                        <div class="value negative" id="loseCount">0å›</div>
                    </div>
                    <div class="stats-card">
                        <h4>ç·åˆ©ç›Š</h4>
                        <div class="value positive" id="totalProfit">0å††</div>
                    </div>
                    <div class="stats-card">
                        <h4>å¹³å‡åˆ©ç›Šç‡</h4>
                        <div class="value neutral" id="avgProfitRate">0%</div>
                    </div>
                </div>

                <div class="result">
                    <h3>ğŸ“ˆ æœˆåˆ¥æˆç¸¾</h3>
                    <div class="result-item">
                        <span>ä»Šæœˆã®å–å¼•:</span>
                        <span id="monthlyTrades" class="neutral">0å›</span>
                    </div>
                    <div class="result-item">
                        <span>ä»Šæœˆã®æç›Š:</span>
                        <span id="monthlyProfit" class="neutral">0å††</span>
                    </div>
                    <div class="result-item">
                        <span>ä»Šæœˆã®å‹ç‡:</span>
                        <span id="monthlyWinRate" class="neutral">0%</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ã‚°ãƒ©ãƒ•ã‚¿ãƒ– -->
        <div id="chart" class="tab-content">
            <div class="section">
                <h2>ğŸ“ˆ æç›Šæ¨ç§»ã‚°ãƒ©ãƒ•</h2>
                <div class="chart-container">
                    <canvas id="profitChart"></canvas>
                </div>
            </div>
            
            <div class="section">
                <h2>ğŸ¥§ å‹æ•—æ¯”ç‡</h2>
                <div class="chart-container">
                    <canvas id="winLossChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ãƒ‡ãƒ¼ã‚¿ç®¡ç†ï¼ˆLocalStorageä½¿ç”¨ï¼‰
        let tradeHistory = [];
        let charts = {};

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            if (tabName === 'chart') {
                setTimeout(updateCharts, 100);
            }
            if (tabName === 'stats') {
                updateStats();
            }
        }

        // ä¿å­˜ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼è¡¨ç¤º
        function showSaveIndicator() {
            const indicator = document.getElementById('saveIndicator');
            indicator.style.display = 'block';
            setTimeout(() => {
                indicator.style.display = 'none';
            }, 2000);
        }

        // ãƒ‡ãƒ¼ã‚¿ä¿å­˜ãƒ»èª­ã¿è¾¼ã¿ï¼ˆLocalStorageä½¿ç”¨ï¼‰
        function saveData() {
            try {
                const data = {
                    history: tradeHistory,
                    lastSaved: new Date().toISOString()
                };
                localStorage.setItem('stockTradingData', JSON.stringify(data));
                showSaveIndicator();
            } catch (e) {
                console.warn('ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ:', e);
            }
        }

        function loadData() {
            try {
                const saved = localStorage.getItem('stockTradingData');
                if (saved) {
                    const data = JSON.parse(saved);
                    tradeHistory = data.history || [];
                    updateHistoryTable();
                    updateStats();
                }
            } catch (e) {
                console.warn('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:', e);
                tradeHistory = [];
            }
        }

        // å–å¼•è¨ˆç®—
        function calculateTrade() {
            const buyPrice = parseFloat(document.getElementById('buyPrice').value) || 0;
            const buyShares = parseInt(document.getElementById('buyShares').value) || 0;
            const sellPrice = parseFloat(document.getElementById('sellPrice').value) || 0;
            const buyFee = 99;

            const buyAmount = buyPrice * buyShares;
            const sellAmount = sellPrice * buyShares;
            const totalFees = buyFee * 2;
            const grossProfit = sellAmount - buyAmount - totalFees;
            const tax = grossProfit > 0 ? grossProfit * 0.20315 : 0;
            const finalProfit = grossProfit - tax;
            const profitRate = buyAmount > 0 ? (finalProfit / buyAmount) * 100 : 0;

            document.getElementById('totalBuyAmount').textContent = (buyAmount + buyFee).toLocaleString() + 'å††';
            document.getElementById('totalSellAmount').textContent = sellAmount.toLocaleString() + 'å††';
            document.getElementById('totalFees').textContent = totalFees.toLocaleString() + 'å††';
            document.getElementById('totalTax').textContent = tax.toLocaleString() + 'å††';
            document.getElementById('finalProfit').textContent = finalProfit.toLocaleString() + 'å††';
            document.getElementById('profitRate').textContent = profitRate.toFixed(2) + '%';

            // è‰²åˆ†ã‘
            const profitElement = document.getElementById('finalProfit');
            const rateElement = document.getElementById('profitRate');
            
            if (finalProfit > 0) {
                profitElement.className = 'positive';
                rateElement.className = 'positive';
            } else if (finalProfit < 0) {
                profitElement.className = 'negative';
                rateElement.className = 'negative';
            } else {
                profitElement.className = 'neutral';
                rateElement.className = 'neutral';
            }

            calculateProfitLoss();
        }

        function calculateProfitLoss() {
            const buyPrice = parseFloat(document.getElementById('buyPrice').value) || 0;
            const buyShares = parseInt(document.getElementById('buyShares').value) || 0;
            const profitPrice = parseFloat(document.getElementById('profitPrice').value) || 0;
            const lossPrice = parseFloat(document.getElementById('lossPrice').value) || 0;
            const buyFee = 99;

            const buyAmount = buyPrice * buyShares;
            const totalFees = buyFee * 2;

            // åˆ©ç¢ºè¨ˆç®—
            if (profitPrice > 0 && buyShares > 0) {
                const profitSellAmount = profitPrice * buyShares;
                const profitGross = profitSellAmount - buyAmount - totalFees;
                const profitTax = profitGross > 0 ? profitGross * 0.20315 : 0;
                const profitFinal = profitGross - profitTax;
                const profitRate = buyAmount > 0 ? (profitFinal / buyAmount) * 100 : 0;

                document.getElementById('profitAmount').textContent = '+' + profitFinal.toLocaleString() + 'å††';
                document.getElementById('profitAmountRate').textContent = '+' + profitRate.toFixed(2) + '%';
            }

            // æåˆ‡è¨ˆç®—
            if (lossPrice > 0 && buyShares > 0) {
                const lossSellAmount = lossPrice * buyShares;
                const lossGross = lossSellAmount - buyAmount - totalFees;
                const lossTax = lossGross > 0 ? lossGross * 0.20315 : 0;
                const lossFinal = lossGross - lossTax;
                const lossRate = buyAmount > 0 ? (lossFinal / buyAmount) * 100 : 0;

                document.getElementById('lossAmount').textContent = lossFinal.toLocaleString() + 'å††';
                document.getElementById('lossAmountRate').textContent = lossRate.toFixed(2) + '%';
            }
        }

        // å–å¼•è¨˜éŒ²
        function recordTrade() {
            const stockName = document.getElementById('stockName').value || 'æœªå…¥åŠ›';
            const buyPrice = parseFloat(document.getElementById('buyPrice').value) || 0;
            const buyShares = parseInt(document.getElementById('buyShares').value) || 0;
            const sellPrice = parseFloat(document.getElementById('sellPrice').value) || 0;

            if (buyPrice > 0 && buyShares > 0 && sellPrice > 0) {
                const buyAmount = buyPrice * buyShares;
                const sellAmount = sellPrice * buyShares;
                const totalFees = 99 * 2;
                const grossProfit = sellAmount - buyAmount - totalFees;
                const tax = grossProfit > 0 ? grossProfit * 0.20315 : 0;
                const finalProfit = grossProfit - tax;
                const profitRate = (finalProfit / buyAmount) * 100;

                const trade = {
                    id: Date.now(),
                    date: new Date().toLocaleDateString('ja-JP'),
                    stockName: stockName,
                    buyPrice: buyPrice,
                    sellPrice: sellPrice,
                    shares: buyShares,
                    profit: finalProfit,
                    profitRate: profitRate,
                    isWin: finalProfit > 0
                };

                tradeHistory.push(trade);
                saveData();
                updateHistoryTable();
                updateStats();

                // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚¯ãƒªã‚¢
                document.getElementById('stockName').value = '';
                document.getElementById('buyPrice').value = '';
                document.getElementById('buyShares').value = '';
                document.getElementById('sellPrice').value = '';
                calculateTrade();

                alert('å–å¼•ã‚’è¨˜éŒ²ã—ã¾ã—ãŸï¼');
            } else {
                alert('ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
            }
        }

        // å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°
        function updateHistoryTable() {
            const tbody = document.getElementById('historyBody');
            tbody.innerHTML = '';

            tradeHistory.slice().reverse().forEach(trade => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${trade.date}</td>
                    <td>${trade.stockName}</td>
                    <td>${trade.shares}</td>
                    <td>Â¥${trade.buyPrice.toLocaleString()}</td>
                    <td>Â¥${trade.sellPrice.toLocaleString()}</td>
                    <td class="${trade.profit >= 0 ? 'positive' : 'negative'}">Â¥${trade.profit.toLocaleString()}</td>
                    <td class="${trade.profitRate >= 0 ? 'positive' : 'negative'}">${trade.profitRate.toFixed(2)}%</td>
                    <td><button onclick="removeTrade(${trade.id})" class="remove-button">å‰Šé™¤</button></td>
                `;
            });
        }

        // çµ±è¨ˆæ›´æ–°
        function updateStats() {
            const totalTrades = tradeHistory.length;
            const wins = tradeHistory.filter(t => t.isWin).length;
            const losses = totalTrades - wins;
            const winRate = totalTrades > 0 ? (wins / totalTrades) * 100 : 0;
            const totalProfit = tradeHistory.reduce((sum, t) => sum + t.profit, 0);
            const avgProfitRate = totalTrades > 0 ? tradeHistory.reduce((sum, t) => sum + t.profitRate, 0) / totalTrades : 0;

            // ä»Šæœˆã®ãƒ‡ãƒ¼ã‚¿
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const monthlyTrades = tradeHistory.filter(t => {
                const tradeDate = new Date(t.date);
                return tradeDate.getMonth() === currentMonth && tradeDate.getFullYear() === currentYear;
            });
            const monthlyWins = monthlyTrades.filter(t => t.isWin).length;
            const monthlyWinRate = monthlyTrades.length > 0 ? (monthlyWins / monthlyTrades.length) * 100 : 0;
            const monthlyProfit = monthlyTrades.reduce((sum, t) => sum + t.profit, 0);

            document.getElementById('totalTrades').textContent = totalTrades + 'å›';
            document.getElementById('winRate').textContent = winRate.toFixed(1) + '%';
            document.getElementById('winCount').textContent = wins + 'å›';
            document.getElementById('loseCount').textContent = losses + 'å›';
            document.getElementById('totalProfit').textContent = totalProfit.toLocaleString() + 'å††';
            document.getElementById('avgProfitRate').textContent = avgProfitRate.toFixed(2) + '%';
            
            document.getElementById('monthlyTrades').textContent = monthlyTrades.length + 'å›';
            document.getElementById('monthlyProfit').textContent = monthlyProfit.toLocaleString() + 'å††';
            document.getElementById('monthlyWinRate').textContent = monthlyWinRate.toFixed(1) + '%';

            // è‰²åˆ†ã‘
            document.getElementById('totalProfit').className = totalProfit >= 0 ? 'positive' : 'negative';
            document.getElementById('monthlyProfit').className = monthlyProfit >= 0 ? 'positive' : 'negative';
        }

        // ã‚°ãƒ©ãƒ•æ›´æ–°
        function updateCharts() {
            updateProfitChart();
            updateWinLossChart();
        }

        function updateProfitChart() {
            const ctx = document.getElementById('profitChart').getContext('2d');
            
            if (charts.profit) {
                charts.profit.destroy();
            }

            // ç´¯ç©æç›Šã®ãƒ‡ãƒ¼ã‚¿ä½œæˆ
            let cumulativeProfit = 0;
            const data = tradeHistory.map((trade, index) => {
                cumulativeProfit += trade.profit;
                return {
                    x: index + 1,
                    y: cumulativeProfit
                };
            });

            charts.profit = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'ç´¯ç©æç›Š (å††)',
                        data: data,
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        tension: 0.2,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'å–å¼•å›æ•°'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'ç´¯ç©æç›Š (å††)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        function updateWinLossChart() {
            const ctx = document.getElementById('winLossChart').getContext('2d');
            
            if (charts.winLoss) {
                charts.winLoss.destroy();
            }

            const wins = tradeHistory.filter(t => t.isWin).length;
            const losses = tradeHistory.length - wins;

            if (wins === 0 && losses === 0) {
                // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ã‚°ãƒ©ãƒ•ã‚’è¡¨ç¤ºã—ãªã„
                return;
            }

            charts.winLoss = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['å‹ã¡', 'è² ã‘'],
                    datasets: [{
                        data: [wins, losses],
                        backgroundColor: ['#27ae60', '#e74c3c'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // å–å¼•å‰Šé™¤
        function removeTrade(id) {
            if (confirm('ã“ã®å–å¼•ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                tradeHistory = tradeHistory.filter(trade => trade.id !== id);
                saveData();
                updateHistoryTable();
                updateStats();
            }
        }

        // ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        function exportData() {
            if (tradeHistory.length === 0) {
                alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }

            const csvContent = "data:text/csv;charset=utf-8," 
                + "æ—¥ä»˜,éŠ˜æŸ„å,è³¼å…¥ä¾¡æ ¼,å£²å´ä¾¡æ ¼,æ ªæ•°,æç›Š,æç›Šç‡\n"
                + tradeHistory.map(trade => 
                    `${trade.date},${trade.stockName},${trade.buyPrice},${trade.sellPrice},${trade.shares},${trade.profit},${trade.profitRate}%`
                ).join("\n");

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `æ ªå–å¼•å±¥æ­´_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
        function backupData() {
            if (tradeHistory.length === 0) {
                alert('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }

            const backupData = {
                version: '1.0',
                exportDate: new Date().toISOString(),
                tradeHistory: tradeHistory
            };

            const dataStr = JSON.stringify(backupData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement("a");
            link.href = URL.createObjectURL(dataBlob);
            link.download = `æ ªå–å¼•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚');
        }

        // å±¥æ­´ã‚¯ãƒªã‚¢
        function clearHistory() {
            if (confirm('ã™ã¹ã¦ã®å–å¼•å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
                tradeHistory = [];
                saveData();
                updateHistoryTable();
                updateStats();
                updateCharts();
                alert('å±¥æ­´ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚');
            }
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        document.getElementById('buyPrice').addEventListener('input', calculateTrade);
        document.getElementById('buyShares').addEventListener('input', calculateTrade);
        document.getElementById('sellPrice').addEventListener('input', calculateTrade);
        document.getElementById('profitPrice').addEventListener('input', calculateProfitLoss);
        document.getElementById('lossPrice').addEventListener('input', calculateProfitLoss);

        // åˆæœŸåŒ–
        window.addEventListener('load', function() {
            loadData();
            calculateTrade();
            updateStats();
        });
    </script>
</body>
</html>
